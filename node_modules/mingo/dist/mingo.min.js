var mingo=(()=>{var Xr=Object.defineProperty;var ro=Object.getOwnPropertyDescriptor;var eo=Object.getOwnPropertyNames;var no=Object.prototype.hasOwnProperty;var lt=(t,r)=>{for(var n in r)Xr(t,n,{get:r[n],enumerable:!0})},oo=(t,r,n,e)=>{if(r&&typeof r=="object"||typeof r=="function")for(let o of eo(r))!no.call(t,o)&&o!==n&&Xr(t,o,{get:()=>r[o],enumerable:!(e=ro(r,o))||e.enumerable});return t};var so=t=>oo(Xr({},"__esModule",{value:!0}),t);var ca={};lt(ca,{Aggregator:()=>Gr,Context:()=>tt,ProcessingMode:()=>wt,Query:()=>Hr,aggregate:()=>ma,createUpdater:()=>Zn,find:()=>ua,update:()=>aa});var Dt=class extends Error{},Gt=Symbol("missing"),Ze="mingo: cycle detected while processing object/array",Jt=t=>{let r=vt(t),n=0,e=r.length;for(;e;)n=(n<<5)-n^r.charCodeAt(--e);return n>>>0},Ct=t=>typeof t!="object"&&typeof t!="function"||t===null,tn=t=>Ct(t)||S(t)||H(t),rn={undefined:1,null:2,number:3,string:4,symbol:5,object:6,array:7,arraybuffer:8,boolean:9,date:10,regexp:11,function:12};function w(t,r){t===Gt&&(t=void 0),r===Gt&&(r=void 0);let n=100,[e,o]=[t,r].map(s=>rn[nn(s)?"arraybuffer":Q(s)]??n);return e!==o?e-o:(e===n&&(t=vt(t),r=vt(r)),B(t,r)?0:t<r?-1:1)}var q=class t extends Map{#t=Jt;#r=new Map;#e=r=>{let n=this.#t(r);return[(this.#r.get(n)||[]).find(e=>B(e,r)),n]};constructor(){super()}static init(r){let n=new t;return r&&(n.#t=r),n}clear(){super.clear(),this.#r.clear()}delete(r){if(Ct(r))return super.delete(r);let[n,e]=this.#e(r);return super.delete(n)?(this.#r.set(e,this.#r.get(e).filter(o=>!B(o,n))),!0):!1}get(r){if(Ct(r))return super.get(r);let[n,e]=this.#e(r);return super.get(n)}has(r){if(Ct(r))return super.has(r);let[n,e]=this.#e(r);return super.has(n)}set(r,n){if(Ct(r))return super.set(r,n);let[e,o]=this.#e(r);if(super.has(e))super.set(e,n);else{super.set(r,n);let s=this.#r.get(o)||[];s.push(r),this.#r.set(o,s)}return this}get size(){return super.size}};function m(t,r){if(!t)throw new Dt(r)}function Q(t){if(t===null)return"null";let r=typeof t;if(r!=="object"&&r in rn)return r;if(y(t))return"array";if(S(t))return"date";if(H(t))return"regexp";let n=Object.prototype.toString.call(t);return n==="[object Object]"?t?.constructor?.name?.toLowerCase()??"object":n.slice(8,-1).toLowerCase()}var ft=t=>typeof t=="boolean",h=t=>typeof t=="string",io=t=>typeof t=="symbol",d=t=>!isNaN(t)&&typeof t=="number",y=Array.isArray,j=t=>Q(t)==="object",en=t=>!Ct(t),S=t=>t instanceof Date,H=t=>t instanceof RegExp,Xt=t=>typeof t=="function",l=t=>t==null,L=(t,r=!0)=>!!t||r&&t==="",Y=t=>l(t)||h(t)&&!t||y(t)&&t.length===0||j(t)&&Object.keys(t).length===0,et=t=>y(t)?t:[t],M=(t,r)=>!!t&&Object.prototype.hasOwnProperty.call(t,r),nn=t=>typeof ArrayBuffer<"u"&&ArrayBuffer.isView(t),G=(t,r)=>{if(l(t)||ft(t)||d(t)||h(t))return t;if(S(t))return new Date(t);if(H(t))return new RegExp(t);if(nn(t)){let n=t.constructor;return new n(t)}if(r instanceof Set||(r=new Set),r.has(t))throw new Error(Ze);r.add(t);try{if(y(t)){let n=new Array(t.length);for(let e=0;e<t.length;e++)n[e]=G(t[e],r);return n}if(j(t)){let n={};for(let e of Object.keys(t))n[e]=G(t[e],r);return n}}finally{r.delete(t)}return t},Je=t=>t===Gt;function fr(t,r){if(Je(t)||l(t))return r;if(Je(r)||l(r))return t;let n=Q(t);if(n!==Q(r))return r;if(y(t)&&y(r))for(let e=0;e<r.length;e++)e<t.length?t[e]=fr(t[e],r[e]):t.push(r[e]);else if(n==="object")for(let e of Object.keys(r))t[e]=fr(t[e],r[e]);return t}function Mt(t,r=Jt){let n=[q.init(r),q.init(r)];if(t.length===0)return[];if(t.some(e=>e.length===0))return[];if(t.length===1)return[...t[0]];t[t.length-1].forEach(e=>n[0].set(e,!0));for(let e=t.length-2;e>-1;e--){if(t[e].forEach(o=>{n[0].has(o)&&n[1].set(o,!0)}),n[1].size===0)return[];n.reverse(),n[1].clear()}return Array.from(n[0].keys())}function nt(t,r=1){let n=new Array;function e(o,s){for(let p=0,i=o.length;p<i;p++)y(o[p])&&(s>0||s<0)?e(o[p],Math.max(-1,s-1)):n.push(o[p])}return e(t,r),n}function po(t){let r={};for(;t;){for(let n of Object.getOwnPropertyNames(t))n in r||(r[n]=t[n]);t=Object.getPrototypeOf(t)}return r}var on=t=>t!=null&&t.toString!==Object.prototype.toString;function B(t,r){if(t===r||Object.is(t,r))return!0;if(t===null||r===null||typeof t!=typeof r||typeof t!="object")return!1;if(S(t))return S(r)&&+t==+r;if(H(t))return H(r)&&t.toString()===r.toString();let n=Q(t);if(n!==Q(r))return!1;switch(n){case"array":if(t.length!==r.length)return!1;for(let e=0,o=t.length;e<o;e++)if(!B(t[e],r[e]))return!1;return!0;case"object":{let e=Object.keys(t),o=Object.keys(r);if(e.length!==o.length)return!1;for(let s of e)if(!(s in r&&B(t[s],r[s])))return!1;return!0}default:return on(t)&&t.toString()===r.toString()}}function Pt(t,r=Jt){let n=q.init(r);return t.forEach(e=>n.set(e,!0)),Array.from(n.keys())}function vt(t,r){if(t===null)return"null";if(t===void 0)return"undefined";if(h(t)||d(t)||ft(t))return JSON.stringify(t);if(S(t))return t.toISOString();if(H(t)||io(t)||Xt(t))return t.toString();if(r instanceof Set||(r=new Set),r.has(t))throw new Error(Ze);try{if(r.add(t),y(t))return"["+t.map(e=>vt(e,r)).join(",")+"]";if(j(t))return"{"+Object.keys(t).sort().map(o=>`${o}:${vt(t[o],r)}`).join()+"}";let n=on(t)?t.toString():vt(po(t),r);return Q(t)+"("+n+")"}finally{r.delete(t)}}function Zt(t,r){return l(t)?null:(r=r||Jt,r(t))}function Rt(t,r,n=Jt){if(t.length<1)return new Map;let e=q.init(n);for(let o=0;o<t.length;o++){let s=t[o],p=r(s,o)??null,i=e.get(p);i?i.push(s):(i=[s],e.set(p,i))}return e}function Zr(t,r){return en(t)?t[r]:void 0}function ao(t,r){if(r<1)return t;for(;r--&&t.length===1&&y(t[0]);)t=t[0];return t}function k(t,r,n){let e=0;function o(p,i){let a=p;for(let c=0;c<i.length;c++){let f=i[c];if(/^\d+$/.exec(f)===null&&y(a)){if(c===0&&e>0)break;e+=1;let O=i.slice(c);a=a.reduce((b,x)=>{let g=o(x,O);return g!==void 0&&b.push(g),b},[]);break}else a=Zr(a,f);if(a===void 0)break}return a}let s=tn(t)?t:o(t,r.split("."));return y(s)&&n?.unwrapArray?ao(s,e):s}function bt(t,r,n){let e=r.indexOf("."),o=e==-1?r:r.substring(0,e),s=r.substring(e+1),p=e!=-1;if(y(t)){let c=/^\d+$/.test(o),f=c&&n?.preserveIndex?[...t]:[];if(c){let A=parseInt(o),O=Zr(t,A);p&&(O=bt(O,s,n)),n?.preserveIndex?f[A]=O:f.push(O)}else for(let A of t){let O=bt(A,r,n);n?.preserveMissing?f.push(O??Gt):(O!=null||n?.preserveIndex)&&f.push(O)}return f}let i=n?.preserveKeys?{...t}:{},a=Zr(t,o);if(p&&(a=bt(a,s,n)),a!==void 0)return i[o]=a,i}function yr(t){if(y(t))for(let r=t.length-1;r>=0;r--)t[r]===Gt?t.splice(r,1):yr(t[r]);else if(j(t))for(let r in t)M(t,r)&&yr(t[r])}var Xe=/^\d+$/;function _t(t,r,n,e){let o=r.split("."),s=o[0],p=o.slice(1).join(".");if(o.length===1)(j(t)||y(t)&&Xe.test(s))&&n(t,s);else{e?.buildGraph&&l(t[s])&&(t[s]={});let i=t[s];if(!i)return;let a=!!(o.length>1&&Xe.test(o[1]));y(i)&&e?.descendArray&&!a?i.forEach((c=>_t(c,p,n,e))):_t(i,p,n,e)}}function ht(t,r,n){_t(t,r,((e,o)=>{e[o]=Xt(n)?n(e[o]):n}),{buildGraph:!0})}function It(t,r,n){_t(t,r,((e,o)=>{y(e)?e.splice(parseInt(o),1):j(e)&&delete e[o]}),n)}var J=t=>t&&t[0]==="$"&&/^\$[a-zA-Z0-9_]+$/.test(t);function Or(t){if(tn(t))return H(t)?{$regex:t}:{$eq:t};if(en(t)){if(!Object.keys(t).some(J))return{$eq:t};if(M(t,"$regex")){let r={...t};return r.$regex=new RegExp(t.$regex,t.$options),delete r.$options,r}}return t}function Ut(t,r,n=w){let e=0,o=t.length-1;for(;e<=o;){let s=Math.round(e+(o-e)/2);if(n(r,t[s])<0)o=s-1;else if(n(r,t[s])>0)e=s+1;else return s}return e}var wt=(o=>(o[o.CLONE_OFF=0]="CLONE_OFF",o[o.CLONE_INPUT=1]="CLONE_INPUT",o[o.CLONE_OUTPUT=2]="CLONE_OUTPUT",o[o.CLONE_ALL=3]="CLONE_ALL",o))(wt||{}),I=class t{#t;#r;#e;constructor(r,n,e){this.#t=r,this.#e={},this.update(n,e)}static init(r,n,e){return r instanceof t?new t(r.#t,null,r.#e).update(r.#r??n,e):new t(r,n,e)}update(r,n){return this.#r=r,Object.assign(this.#e,{variables:{...this.#e?.variables,...n?.variables},groupId:n?.groupId??this.#e?.groupId,now:this.#e?.now??n?.now??Date.now()}),this}getOptions(){return Object.freeze({...this.#t,context:tt.from(this.#t.context)})}get root(){return this.#r}get local(){return this.#e}get idKey(){return this.#t.idKey}get collation(){return this.#t?.collation}get processingMode(){return this.#t?.processingMode||0}get useStrictMode(){return this.#t?.useStrictMode}get scriptEnabled(){return this.#t?.scriptEnabled}get useGlobalContext(){return this.#t?.useGlobalContext}get hashFunction(){return this.#t?.hashFunction}get collectionResolver(){return this.#t?.collectionResolver}get jsonSchemaValidator(){return this.#t?.jsonSchemaValidator}get variables(){return this.#t?.variables}get context(){return this.#t?.context}};function yt(t){return t instanceof I?t.getOptions():Object.freeze({idKey:"_id",scriptEnabled:!0,useStrictMode:!0,useGlobalContext:!0,processingMode:0,...t,context:tt.from(t?.context??tt.init())})}var Tt=(p=>(p.ACCUMULATOR="accumulator",p.EXPRESSION="expression",p.PIPELINE="pipeline",p.PROJECTION="projection",p.QUERY="query",p.WINDOW="window",p))(Tt||{}),tt=class t{#t=new Map(Object.values(Tt).map(r=>[r,{}]));constructor(){}static init(r={}){let n=new t;for(let[e,o]of Object.entries(r))n.#t.has(e)&&o&&n.addOperators(e,o);return n}static from(r){return t.init(r&&Object.fromEntries(r.#t)||{})}static merge(r,n){let e=t.from(r);for(let o of Object.values(Tt))e.addOperators(o,n.#t.get(o));return e}addOperators(r,n){return this.#t.set(r,Object.assign({},n,this.#t.get(r))),this}getOperator(r,n){return this.#t.get(r)[n]??null}addAccumulatorOps(r){return this.addOperators("accumulator",r)}addExpressionOps(r){return this.addOperators("expression",r)}addQueryOps(r){return this.addOperators("query",r)}addPipelineOps(r){return this.addOperators("pipeline",r)}addProjectionOps(r){return this.addOperators("projection",r)}addWindowOps(r){return this.addOperators("window",r)}},ot=tt.init(),Oa={accumulator:ot.addAccumulatorOps.bind(ot),expression:ot.addExpressionOps.bind(ot),pipeline:ot.addPipelineOps.bind(ot),projection:ot.addProjectionOps.bind(ot),query:ot.addQueryOps.bind(ot),window:ot.addWindowOps.bind(ot)};function st(t,r,n){if(!J(r))return null;let{context:e,useGlobalContext:o}=n||{},s=e?e.getOperator(t,r):null;return!s&&o?ot.getOperator(t,r):s}function u(t,r,n,e){let o=I.init(e,t);return n&&J(n)?sn(t,r,n,o):Ar(t,r,o)}var mo=["$$ROOT","$$CURRENT","$$REMOVE","$$NOW"];function Ar(t,r,n){if(h(r)&&r.length>0&&r[0]==="$"){if(uo.includes(r))return r;let e=n.root,o=r.split(".");if(mo.includes(o[0])){switch(o[0]){case"$$ROOT":break;case"$$CURRENT":e=t;break;case"$$REMOVE":e=void 0;break;case"$$NOW":e=new Date(n.local?.now);break}r=r.slice(o[0].length+1)}else if(o[0].slice(0,2)==="$$"){e=Object.assign({},n.variables,{this:t},n?.local?.variables);let s=o[0].slice(2);m(M(e,s),`Use of undefined variable: ${s}`),r=r.slice(2)}else r=r.slice(1);return r===""?e:k(e,r)}if(y(r))return r.map(e=>Ar(t,e,n));if(j(r)){let e={},o=Object.entries(r);for(let[s,p]of o){if(J(s))return m(o.length==1,"expression must have single operator."),sn(t,p,s,n);e[s]=Ar(t,p,n)}return e}return r}function sn(t,r,n,e){let o=st("expression",n,e);if(o)return o(t,r,e);let s=st("accumulator",n,e);return m(!!s,`accumulator '${n}' is not registered.`),y(t)||(t=Ar(t,r,e),r=null),m(y(t),`arguments must resolve to array for ${n}.`),s(t,r,e)}var uo=["$$KEEP","$$PRUNE","$$DESCEND"];function br(t,r,n){let e=u(t,r,null,n);switch(e){case"$$KEEP":return t;case"$$PRUNE":return;case"$$DESCEND":{if(!M(r,"$cond"))return t;let o={};for(let[s,p]of Object.entries(t))if(y(p)){let i=new Array;for(let a of p)j(a)&&(a=br(a,r,n.update(a))),l(a)||i.push(a);o[s]=i}else if(j(p)){let i=br(p,r,n.update(p));l(i)||(o[s]=i)}else o[s]=p;return o}default:return e}}function N(t){return t instanceof Ft?t:new Ft(t)}function dt(...t){let r=0;return N(()=>{for(;r<t.length;){let n=t[r].next();if(!n.done)return n;r++}return{done:!0}})}function co(t){return!!t&&typeof t=="object"&&typeof t?.next=="function"}function lo(t){return!!t&&(typeof t=="object"||typeof t=="function")&&typeof t[Symbol.iterator]=="function"}var Ft=class{#t=[];#r=[];#e;#o=!1;constructor(r){let n=lo(r)?r[Symbol.iterator]():co(r)?r:typeof r=="function"?{next:r}:null;m(!!n,"Iterator must be initialized with an iterable or function.");let e=-1,o={done:!1};this.#e=()=>{for(;!o.done&&(o=n.next(),!o.done);){let s=o.value;if(e++,this.#t.every(({op:i,fn:a})=>{let c=a(s,e);return i==="map"?!!(s=c)||!0:c}))return{value:s,done:!1}}return{done:!0}}}push(r,n){return this.#t.push({op:r,fn:n}),this}next(){return this.#e()}map(r){return this.push("map",r)}filter(r){return this.push("filter",r)}take(r){return r>0?this.filter(n=>!(r===0||r--===0)):this}drop(r){return r>0?this.filter(n=>r===0||r--===0):this}transform(r){let n=this,e;return N(()=>(e||(e=N(r(n.value()))),e.next()))}value(){for(;!this.#o;){let{done:r,value:n}=this.#e();r||this.#r.push(n),this.#o=r}return this.#r}each(r){for(;;){let n=this.next();if(n.done)break;if(r(n.value)===!1)return!1}return!0}reduce(r,n){let e=this.next();for(n===void 0&&!e.done&&(n=e.value,e=this.next());!e.done;)n=r(n,e.value),e=this.next();return n}size(){return this.reduce(((r,n)=>++r),0)}[Symbol.iterator](){return this}};var pt=class{#t;#r;constructor(r,n){this.#t=r,this.#r=n}stream(r,n){let e=N(r),o=n??this.#r,s=o.processingMode;return s&1&&e.map(G),e=this.#t.map((p,i)=>{let a=Object.keys(p);m(a.length===1,`aggregation stage must have single operator, got ${a.toString()}.`);let c=a[0];m(c!=="$documents"||i==0,"$documents must be first stage in pipeline.");let f=st("pipeline",c,o);return m(!!f,`unregistered pipeline operator ${c}.`),[f,p[c]]}).reduce((p,[i,a])=>i(p,a,o),e),s&2&&e.map(G),e}run(r,n){return this.stream(r,n).value()}};var ie={};lt(ie,{$accumulator:()=>fo,$addToSet:()=>yo,$avg:()=>Oo,$bottom:()=>xo,$bottomN:()=>te,$count:()=>go,$covariancePop:()=>ho,$covarianceSamp:()=>jo,$first:()=>re,$firstN:()=>gr,$last:()=>ee,$lastN:()=>hr,$max:()=>Eo,$maxN:()=>jr,$median:()=>ne,$mergeObjects:()=>oe,$min:()=>$o,$minN:()=>Er,$percentile:()=>tr,$push:()=>E,$stdDevPop:()=>Io,$stdDevSamp:()=>To,$sum:()=>wo,$top:()=>No,$topN:()=>se});var fo=(t,r,n)=>{if(m(!!n&&n.scriptEnabled,"$accumulator operator requires 'scriptEnabled' option to be true"),t.length==0)return r.initArgs;let e=I.init(n),o=u({},r.initArgs||[],null,e.update(e?.local?.groupId||{})),s=r.init.call(null,...o);for(let p of t){let i=u(p,r.accumulateArgs,null,e.update(p));s=r.accumulate.call(null,s,...i)}return r.finalize?r.finalize.call(null,s):s};var E=(t,r,n)=>{if(l(r))return t;let e=I.init(n);return t.map(o=>u(o,r,null,e.update(o)))};var yo=(t,r,n)=>Pt(E(t,r,n),n?.hashFunction);var Oo=(t,r,n)=>{let e=E(t,r,n).filter(d);return e.reduce((s,p)=>s+p,0)/(e.length||1)};var Z=(t,r,n)=>{if(Y(r)||!j(r))return t;let e=w,o=n.collation;return j(o)&&h(o.locale)&&(e=bo(o)),t.transform(s=>{let p=Object.keys(r);for(let i of p.reverse()){let a=Rt(s,A=>k(A,i),n.hashFunction),c=Array.from(a.keys()).sort(e);r[i]===-1&&c.reverse();let f=0;for(let A of c)for(let O of a.get(A))s[f++]=O;m(f==s.length,"bug: counter must match collection size.")}return s})},Ao={1:"base",2:"accent",3:"variant"};function bo(t){let r={sensitivity:Ao[t.strength||3],caseFirst:t.caseFirst==="off"?"false":t.caseFirst||"false",numeric:t.numericOrdering||!1,ignorePunctuation:t.alternate==="shifted"};t.caseLevel===!0&&(r.sensitivity==="base"&&(r.sensitivity="case"),r.sensitivity==="accent"&&(r.sensitivity="variant"));let n=new Intl.Collator(t.locale,r);return(e,o)=>{if(!h(e)||!h(o))return w(e,o);let s=n.compare(e,o);return s<0?-1:s>0?1:0}}var te=(t,r,n)=>{let e=I.init(n),o=u(e.local.groupId,r.n,null,e),s=Z(N(t),r.sortBy,n).value(),p=s.length;return E(p<=o?s:s.slice(p-o),r.output,e)};var xo=(t,r,n)=>te(t,{...r,n:1},n);var go=(t,r,n)=>t.length;function dr(t,r=!0){let n=t.reduce((s,p)=>s+p,0),e=t.length||1,o=n/e;return Math.sqrt(t.reduce((s,p)=>s+Math.pow(p-o,2),0)/(e-Number(r)))}function xr(t,r=!0){if(!t)return null;if(t.length<2)return r?null:0;let n=0,e=0;for(let[s,p]of t)n+=s,e+=p;n/=t.length,e/=t.length;let o=0;for(let[s,p]of t)o+=(s-n)*(p-e);return o/(t.length-Number(r))}var ho=(t,r,n)=>xr(E(t,r,n),!1);var jo=(t,r,n)=>xr(E(t,r,n),!0);var re=(t,r,n)=>{if(t.length===0)return;let e=I.init(n).update(t[0]);return u(t[0],r,null,e)};var gr=(t,r,n)=>{let e=I.init(n),o=t.length,s=u(e?.local?.groupId,r.n,null,e);return m(s>0,"$firstN: 'n' must resolve to a positive integer."),E(o<=s?t:t.slice(0,s),r.input,n)};var ee=(t,r,n)=>{if(t.length===0)return;let e=t[t.length-1],o=I.init(n).update(e);return u(e,r,null,o)};var hr=(t,r,n)=>{let e=I.init(n),o=t.length,s=u(e?.local?.groupId,r.n,null,e);return E(o<=s?t:t.slice(o-s),r.input,n)};var Eo=(t,r,n)=>{let e=E(t,r,n);if(Y(e))return null;m(y(e),"$max: input must resolve to array");let o=e[0];for(let s of e)l(s)||isNaN(s)||w(s,o)>=0&&(o=s);return o};var jr=(t,r,n)=>{let e=I.init(n),o=t.length,s=u(e?.local?.groupId,r.n,null,e),p=E(t,r.input,n).filter(i=>!l(i));return p.sort((i,a)=>-1*w(i,a)),o<=s?p:p.slice(0,s)};var tr=(t,r,n)=>{let e=E(t,r.input,n).filter(d).sort(),o=E(r.p,"$$CURRENT",n).filter(d),s=r.method||"approximate";return o.map(p=>{m(p>0&&p<=1,`percentile value must be between 0 (exclusive) and 1 (inclusive): invalid '${p}'.`);let i=p*(e.length-1)+1,a=Math.floor(i),c=i===a?e[i-1]:e[a-1]+i%1*(e[a]-e[a-1]||0);switch(s){case"exact":return c;case"approximate":{let f=Ut(e,c);return f/e.length>=p?e[Math.max(f-1,0)]:e[f]}}})};var ne=(t,r,n)=>tr(t,{...r,p:[.5]},n).pop();var oe=(t,r,n)=>{let e={};for(let o of t)if(!l(o))for(let s of Object.keys(o))o[s]!==void 0&&(e[s]=o[s]);return e};var $o=(t,r,n)=>{let e=E(t,r,n);if(Y(e))return null;m(y(e),"$min: input must resolve to array");let o=e[0];for(let s of e)l(s)||isNaN(s)||w(s,o)<=0&&(o=s);return o};var Er=(t,r,n)=>{let e=I.init(n),o=t.length,s=u(e?.local?.groupId,r.n,null,e),p=E(t,r.input,n).filter(i=>!l(i));return p.sort(w),o<=s?p:p.slice(0,s)};var Io=(t,r,n)=>dr(E(t,r,n).filter(d),!1);var To=(t,r,n)=>dr(E(t,r,n).filter(d),!0);var wo=(t,r,n)=>y(t)?d(r)?t.length*r:E(t,r,n).filter(d).reduce((o,s)=>o+s,0):0;var se=(t,r,n)=>{let e=I.init(n),{n:o,sortBy:s}=u(e.local.groupId,r,null,e),p=Z(N(t),s,n).take(o).value();return E(p,r.output,e)};var No=(t,r,n)=>se(t,{...r,n:1},n);var Pe={};lt(Pe,{$abs:()=>ko,$acos:()=>Ni,$acosh:()=>ki,$add:()=>So,$allElementsTrue:()=>Xs,$and:()=>An,$anyElementTrue:()=>Zs,$arrayElemAt:()=>Qo,$arrayToObject:()=>qo,$asin:()=>Si,$asinh:()=>Ci,$atan:()=>vi,$atan2:()=>Di,$atanh:()=>_i,$bitAnd:()=>As,$bitNot:()=>bs,$bitOr:()=>ds,$bitXor:()=>xs,$ceil:()=>Co,$cmp:()=>xn,$concat:()=>si,$concatArrays:()=>Ko,$cond:()=>gs,$convert:()=>Qi,$cos:()=>Mi,$cosh:()=>Pi,$dateAdd:()=>Nt,$dateDiff:()=>Ns,$dateFromParts:()=>Cs,$dateFromString:()=>Ps,$dateSubtract:()=>Rs,$dateToParts:()=>Us,$dateToString:()=>we,$dateTrunc:()=>Bs,$dayOfMonth:()=>Ae,$dayOfWeek:()=>be,$dayOfYear:()=>de,$degreesToRadians:()=>Ui,$divide:()=>vo,$eq:()=>gn,$exp:()=>Do,$filter:()=>Yo,$first:()=>Ho,$firstN:()=>Go,$floor:()=>_o,$function:()=>fe,$getField:()=>qs,$gt:()=>hn,$gte:()=>jn,$hour:()=>xe,$ifNull:()=>le,$in:()=>Jo,$indexOfArray:()=>Xo,$indexOfBytes:()=>ii,$isArray:()=>Zo,$isNumber:()=>qi,$isoDayOfWeek:()=>ge,$isoWeek:()=>he,$isoWeekYear:()=>Ls,$last:()=>ts,$lastN:()=>rs,$let:()=>Hi,$literal:()=>zs,$ln:()=>Mo,$log:()=>Po,$log10:()=>Ro,$lt:()=>En,$lte:()=>$n,$ltrim:()=>ai,$map:()=>es,$maxN:()=>ns,$median:()=>Qs,$mergeObjects:()=>Ne,$millisecond:()=>je,$minN:()=>os,$minute:()=>Ee,$mod:()=>Uo,$month:()=>$e,$multiply:()=>Fo,$ne:()=>In,$nin:()=>ms,$not:()=>bn,$objectToArray:()=>Hs,$or:()=>dn,$percentile:()=>Js,$pow:()=>Vo,$radiansToDegrees:()=>Vi,$rand:()=>Ks,$range:()=>us,$reduce:()=>cs,$regexFind:()=>mi,$regexFindAll:()=>ui,$regexMatch:()=>ci,$replaceAll:()=>li,$replaceOne:()=>fi,$reverseArray:()=>ls,$round:()=>Wo,$rtrim:()=>yi,$sampleRate:()=>Ys,$second:()=>Ie,$setDifference:()=>ti,$setEquals:()=>ri,$setField:()=>ke,$setIntersection:()=>ei,$setIsSubset:()=>ni,$setUnion:()=>oi,$sin:()=>Wi,$sinh:()=>Bi,$size:()=>fs,$slice:()=>ce,$sortArray:()=>ys,$split:()=>Oi,$sqrt:()=>Bo,$strLenBytes:()=>bi,$strLenCP:()=>di,$strcasecmp:()=>Ai,$substr:()=>Se,$substrBytes:()=>ji,$substrCP:()=>Ei,$subtract:()=>Lo,$switch:()=>hs,$tan:()=>Li,$tanh:()=>zi,$toBool:()=>Ce,$toDate:()=>ve,$toDecimal:()=>Ki,$toDouble:()=>pr,$toHashedIndexKey:()=>wi,$toInt:()=>De,$toLong:()=>_e,$toLower:()=>$i,$toString:()=>Me,$toUpper:()=>Ii,$trim:()=>Ti,$trunc:()=>zo,$type:()=>Yi,$unsetField:()=>Gs,$week:()=>Te,$year:()=>Br,$zip:()=>Os});var ko=(t,r,n)=>{let e=u(t,r,null,n);return l(e)?null:Math.abs(e)};var So=(t,r,n)=>{let e=u(t,r,null,n),o=!1,s=0;for(let p of e)S(p)&&(m(!o,"'$add' can only have one date value"),o=!0),s+=+p;return o?new Date(s):s};var Co=(t,r,n)=>{let e=u(t,r,null,n);return l(e)?null:(m(d(e)||isNaN(e),"$ceil expression must resolve to a number."),Math.ceil(e))};var vo=(t,r,n)=>{let e=u(t,r,null,n);return e[0]/e[1]};var Do=(t,r,n)=>{let e=u(t,r,null,n);return l(e)?null:(m(d(e)||isNaN(e),"$exp expression must resolve to a number."),Math.exp(e))};var _o=(t,r,n)=>{let e=u(t,r,null,n);return l(e)?null:(m(d(e)||isNaN(e),"$floor expression must resolve to a number."),Math.floor(e))};var Mo=(t,r,n)=>{let e=u(t,r,null,n);return l(e)?null:(m(d(e)||isNaN(e),"$ln expression must resolve to a number."),Math.log(e))};var Po=(t,r,n)=>{let e=u(t,r,null,n),o="$log expression must resolve to array(2) of numbers";return m(y(e)&&e.length===2,o),e.some(l)?null:(m(e.some(isNaN)||e.every(d),o),Math.log10(e[0])/Math.log10(e[1]))};var Ro=(t,r,n)=>{let e=u(t,r,null,n);return l(e)?null:(m(d(e)||isNaN(e),"$log10 expression must resolve to a number."),Math.log10(e))};var Uo=(t,r,n)=>{let e=u(t,r,null,n);return e[0]%e[1]};var Fo=(t,r,n)=>u(t,r,null,n).reduce((o,s)=>o*s,1);var Vo=(t,r,n)=>{let e=u(t,r,null,n);return m(y(e)&&e.length===2&&e.every(d),"$pow expression must resolve to array(2) of numbers"),m(!(e[0]===0&&e[1]<0),"$pow cannot raise 0 to a negative exponent"),Math.pow(e[0],e[1])};function $r(t,r=0,n=!1){let e=Math.abs(t)===t?1:-1;t=Math.abs(t);let o=Math.trunc(t),s=parseFloat((t-o).toFixed(Math.abs(r)+1));if(r===0){let p=Math.trunc(10*s);n&&((o&1)===1&&p>=5||p>5)&&o++}else if(r>0){let p=Math.pow(10,r),i=Math.trunc(s*p),a=Math.trunc(s*p*10)%10;n&&a>5&&(i+=1),o=(o*p+i)/p}else if(r<0){let p=Math.pow(10,-1*r),i=o%p;if(o=Math.max(0,o-i),n&&e===-1){for(;i>10;)i-=i/10;o>0&&i>=5&&(o+=p)}}return o*e}var Wo=(t,r,n)=>{let e=u(t,r,null,n),o=e[0],s=e[1];return l(o)||isNaN(o)||Math.abs(o)===1/0?o:(m(d(o),"$round expression must resolve to a number."),$r(o,s,!0))};var Bo=(t,r,n)=>{let e=u(t,r,null,n);return l(e)?null:(m(d(e)&&e>0||isNaN(e),"$sqrt expression must resolve to non-negative number."),Math.sqrt(e))};var Lo=(t,r,n)=>{let e=u(t,r,null,n),o="$subtract: must resolve to array(2) of numbers/dates";m(y(e)&&e.length===2,o);let s=e.map(Q).join("|");return s==="date|number"?new Date(+e[0]-+e[1]):(m(s==="date|date"||s==="number|number",o),+e[0]-+e[1])};var zo=(t,r,n)=>{let e=u(t,r,null,n),o=e[0],s=e[1];return l(o)||isNaN(o)||Math.abs(o)===1/0?o:(m(d(o),"$trunc expression must resolve to a number."),m(l(s)||d(s)&&s>-20&&s<100,"$trunc expression has invalid place"),$r(o,s,!1))};var Qo=(t,r,n)=>{let e=u(t,r,null,n);if(m(y(e)&&e.length===2,"$arrayElemAt expression must resolve to array(2)"),e.some(l))return null;let o=e[1],s=e[0];if(o<0&&Math.abs(o)<=s.length)return s[(o+s.length)%s.length];if(o>=0&&o<s.length)return s[o]};var qo=(t,r,n)=>{let e=u(t,r,null,n);return m(y(e),"$arrayToObject: expression must resolve to an array"),e.reduce((o,s)=>{for(;y(s)&&s.length===1;)s=s[0];if(y(s)&&s.length==2)o[s[0]]=s[1];else{let p=s;m(j(p)&&M(p,"k")&&M(p,"v"),"$arrayToObject expression is invalid."),o[p.k]=p.v}return o},{})};var Ko=(t,r,n)=>{let e=u(t,r,null,n);m(y(e),"$concatArrays: input must resolve to an array");let o=0;for(let i of e){if(l(i))return null;o+=i.length}let s=new Array(o),p=0;for(let i of e)for(let a of i)s[p++]=a;return s};var Yo=(t,r,n)=>{let e=u(t,r.input,null,n);if(l(e))return null;m(y(e),"$filter 'input' expression must resolve to an array");let o=I.init(n,t),s=r.as||"this",p={variables:{[s]:null}};return e.filter(i=>{p.variables[s]=i;let a=u(t,r.cond,null,o.update(o.root,p));return L(a,n.useStrictMode)})};var Ho=(t,r,n)=>{if(y(t))return re(t,r,n);let e=u(t,r,null,n);return l(e)?null:(m(y(e)&&e.length>0,"$first must resolve to a non-empty array."),nt(e)[0])};var Go=(t,r,n)=>{if(y(t))return gr(t,r,n);let{input:e,n:o}=u(t,r,null,n);return l(e)?null:(m(y(e),"$firstN: 'input' must resolve to an array."),gr(e,{n:o,input:"$$this"},n))};var Jo=(t,r,n)=>{let[e,o]=u(t,r,null,n);return m(y(o),"$in second argument must be an array"),o.some(s=>B(s,e))};var Xo=(t,r,n)=>{let e=u(t,r,null,n);if(l(e))return null;let o=e[0],s=e[1];if(l(o))return null;m(y(o),"$indexOfArray expression must resolve to an array.");let p=e[2]||0,i=e[3];if(l(i)&&(i=o.length),p>i)return-1;m(p>=0&&i>=0,"$indexOfArray expression is invalid"),(p>0||i<o.length)&&(o=o.slice(p,i));let a=-1;return o.some((c,f)=>{let A=B(c,s);return A&&(a=f),A}),a+p};var Zo=(t,r,n)=>{let e=y(r);return m(!e||r.length===1,"$isArray takes exactly 1 argument."),y(u(t,e?r[0]:r,null,n))};var ts=(t,r,n)=>{if(y(t))return ee(t,r,n);let e=u(t,r,null,n);return l(e)?null:(m(y(e)&&e.length>0,"$last must resolve to a non-empty array."),nt(e)[e.length-1])};var rs=(t,r,n)=>{if(y(t))return hr(t,r,n);let{input:e,n:o}=u(t,r,null,n);return l(e)?null:(m(y(e),"Must resolve to an array/null or missing"),hr(e,{n:o,input:"$$this"},n))};var es=(t,r,n)=>{let e=u(t,r.input,null,n);if(l(e))return null;m(y(e),"$map 'input' expression must resolve to an array");let o=I.init(n),s=r.as||"this";return e.map(p=>u(t,r.in,null,o.update(o.root,{variables:{[s]:p}})))};var ns=(t,r,n)=>{if(y(t))return jr(t,r,n);let{input:e,n:o}=u(t,r,null,n);return l(e)?null:(m(y(e),"Must resolve to an array/null or missing"),jr(e,{n:o,input:"$$this"},n))};var os=(t,r,n)=>{if(y(t))return Er(t,r,n);let{input:e,n:o}=u(t,r,null,n);return l(e)?null:(m(y(e),"$minN: 'input' must resolve to an array."),Er(e,{n:o,input:"$$this"},n))};var pe=(t,r,n)=>t.take(r);var rr=(t,r,n)=>Y(r)?t:(an(r,n),t.map(pn(r,I.init(n))));function pn(t,r,n=!0){let e=r.idKey,o=Object.keys(t),s=new Array,p=new Array,i={};for(let O of o){let b=t[O];if(d(b)||ft(b))b?p.push(O):s.push(O);else if(y(b))i[O]=x=>b.map(g=>u(x,g,null,r.update(x))??null);else if(j(b)){let x=Object.keys(b),g=x.length==1?x[0]:"",T=st("projection",g,r);T?g==="$slice"&&!et(b[g]).every(d)?i[O]=D=>u(D,b,O,r.update(D)):i[O]=D=>T(D,b[g],O,r.update(D)):J(g)?i[O]=$=>u($,b[g],g,r):(an(b,r),m(x.length>0,`Invalid empty sub-projection: ${O}`),i[O]=$=>{n&&r.update($);let D=k($,O),W=pn(b,r,!1);if(y(D))return D.map(W);if(j(D))return W(D);let z=W($);return M($,O)||!j(z)||Object.keys(z).length?z:void 0})}else i[O]=h(b)&&b[0]==="$"?x=>u(x,b,O,r):x=>b}let a=Object.keys(i),c=s.includes(e),f=n&&!c&&!p.includes(e),A={preserveMissing:!0};return O=>{let b={};for(let x of p){let g=bt(O,x,A)??{};fr(b,g)}p.length&&yr(b);for(let x of a){let g=i[x](O);g===void 0?It(b,x,{descendArray:!0}):ht(b,x,g)}s.length===1&&c?Object.keys(b).length===0&&Object.assign(b,O):s.length&&Object.assign(b,{...O,...b});for(let x of s)It(b,x,{descendArray:!0});return f&&M(O,e)&&(b[e]=k(O,e)),b}}function an(t,r){let n=!1,e=!1;for(let[o,s]of Object.entries(t))m(!o.startsWith("$"),"Field names may not start with '$'."),m(!o.endsWith(".$"),"Positional projection operator '$' is not supported."),o!==r?.idKey&&(s===0||s===!1?n=!0:(s===1||s===!0)&&(e=!0),m(!(n&&e),"Projection cannot have a mix of inclusion and exclusion."))}var ae=(t,r,n)=>t.drop(r);var ss={$sort:Z,$skip:ae,$limit:pe},Ir=class{#t;#r;#e;#o;#i={};#n=null;#s=[];constructor(r,n,e,o){this.#t=r,this.#r=n,this.#e=e,this.#o=o}fetch(){if(this.#n)return this.#n;this.#n=N(this.#t).filter(this.#r);let r=this.#o.processingMode;r&1&&this.#n.map(G);for(let n of["$sort","$skip","$limit"])M(this.#i,n)&&(this.#n=ss[n](this.#n,this.#i[n],this.#o));return Object.keys(this.#e).length&&(this.#n=rr(this.#n,this.#e,this.#o)),r&2&&this.#n.map(G),this.#n}fetchAll(){let r=N([...this.#s]);return this.#s.length=0,dt(r,this.fetch())}all(){return this.fetchAll().value()}count(){return this.all().length}skip(r){return this.#i.$skip=r,this}limit(r){return this.#i.$limit=r,this}sort(r){return this.#i.$sort=r,this}collation(r){return this.#o={...this.#o,collation:r},this}next(){if(this.#s.length>0)return this.#s.pop();let r=this.fetch().next();if(!r.done)return r.value}hasNext(){if(this.#s.length>0)return!0;let r=this.fetch().next();return r.done?!1:(this.#s.push(r.value),!0)}map(r){return this.all().map(r)}forEach(r){this.all().forEach(r)}[Symbol.iterator](){return this.fetchAll()}};var is=/^\$(and|or|nor|expr|jsonSchema)$/,X=class{#t;#r;#e;constructor(r,n){this.#e=G(r),this.#r=n,this.#t=[],this.compile()}compile(){m(j(this.#e),`query criteria must be an object: ${JSON.stringify(this.#e)}`);let r={};for(let[n,e]of Object.entries(this.#e)){if(n==="$where")m(this.#r.scriptEnabled,"$where operator requires 'scriptEnabled' option to be true."),Object.assign(r,{field:n,expr:e});else if(is.test(n))this.processOperator(n,n,e);else{m(!J(n),`unknown top level operator: ${n}`);for(let[o,s]of Object.entries(Or(e)))this.processOperator(n,o,s)}r.field&&this.processOperator(r.field,r.field,r.expr)}}processOperator(r,n,e){let o=st("query",n,this.#r);m(!!o,`unknown query operator ${n}`),this.#t.push(o(r,e,this.#r))}test(r){return this.#t.every(n=>n(r))}find(r,n){return new Ir(r,e=>this.test(e),n||{},this.#r)}};function C(t,r,n,e){let o={unwrapArray:!0},s=Math.max(1,t.split(".").length-1);return p=>{let i=k(p,t,o);return e(i,r,{...n,depth:s})}}function rt(t,r,n,e){let o=u(t,r,null,n);return e(...o)}function er(t,r,n){return B(t,r)||l(t)&&l(r)?!0:y(t)?t.some(e=>B(e,r))||nt(t,n?.depth).some(e=>B(e,r)):!1}function Tr(t,r,n){return!er(t,r,n)}function me(t,r,n){return l(t)?r.some(e=>e===null):Mt([et(t),r],n?.hashFunction).length>0}function wr(t,r,n){return!me(t,r,n)}function Nr(t,r,n){return vr(t,r,(e,o)=>w(e,o)<0)}function kr(t,r,n){return vr(t,r,(e,o)=>w(e,o)<=0)}function Sr(t,r,n){return vr(t,r,(e,o)=>w(e,o)>0)}function Cr(t,r,n){return vr(t,r,(e,o)=>w(e,o)>=0)}function cn(t,r,n){return et(t).some((e=>r.length===2&&e%r[0]===r[1]))}function ln(t,r,n){let e=et(t),o=s=>h(s)&&L(r.exec(s),n?.useStrictMode);return e.some(o)||nt(e,1).some(o)}function fn(t,r,n){if(!y(t)||!y(r)||!t.length||!r.length)return!1;let e=!0;for(let o of r){if(!e)break;j(o)&&Object.keys(o).includes("$elemMatch")?e=ue(t,o.$elemMatch,n):H(o)?e=t.some(s=>typeof s=="string"&&o.test(s)):e=t.some(s=>B(o,s))}return e}function yn(t,r,n){return Array.isArray(t)&&t.length===r}function ps(t){return J(t)&&["$and","$or","$nor"].indexOf(t)===-1}function ue(t,r,n){if(y(t)&&!Y(t)){let e=p=>p,o=r;Object.keys(r).every(ps)&&(o={temp:r},e=p=>({temp:p}));let s=new X(o,n);for(let p=0,i=t.length;p<i;p++)if(s.test(e(t[p])))return!0}return!1}var mn=t=>t===null,as={array:y,boolean:ft,bool:ft,date:S,number:d,int:d,long:d,double:d,decimal:d,null:mn,object:j,regexp:H,regex:H,string:h,undefined:l,1:d,2:h,3:j,4:y,6:l,8:ft,9:S,10:mn,11:H,16:d,18:d,19:d};function un(t,r,n){let e=as[r];return e?e(t):!1}function On(t,r,n){return y(r)?r.findIndex(e=>un(t,e,n))>=0:un(t,r,n)}function vr(t,r,n){return et(t).some(e=>Q(e)===Q(r)&&n(e,r))}var ms=(t,r,n)=>rt(t,r,n,wr);var us=(t,r,n)=>{let e=u(t,r,null,n),o=e[0],s=e[1],p=e[2]||1,i=new Array,a=o;for(;a<s&&p>0||a>s&&p<0;)i.push(a),a+=p;return i};var cs=(t,r,n)=>{let e=I.init(n),o=u(t,r.input,null,e),s=u(t,r.initialValue,null,e),p=r.in;return l(o)?null:(m(y(o),"$reduce 'input' expression must resolve to an array"),o.reduce((i,a)=>u(a,p,null,e.update(e.root,{variables:{value:i}})),s))};var ls=(t,r,n)=>{let e=u(t,r,null,n);if(l(e))return null;m(y(e),"$reverseArray expression must resolve to an array");let o=e.slice(0);return o.reverse(),o};var fs=(t,r,n)=>{let e=u(t,r,null,n);return y(e)?e.length:void 0};var ce=(t,r,n)=>{let e=u(t,r,null,n),o=e[0],s=e[1],p=e[2];return l(p)?s<0?s=Math.max(0,o.length+s):(p=s,s=0):(s<0&&(s=Math.max(0,o.length+s)),m(p>0,"Invalid argument for $slice operator. Limit must be a positive number"),p+=s),o.slice(s,p)};var ys=(t,r,n)=>{let{input:e,sortBy:o}=u(t,r,null,n);if(l(e))return null;if(m(y(e),"$sortArray expression must resolve to an array"),j(o))return Z(N(e),o,n).value();let s=[...e];return s.sort(w),o===-1&&s.reverse(),s};var Os=(t,r,n)=>{let e=u(t,r.inputs,null,n),o=r.useLongestLength||!1;if(l(e))return null;m(y(e),"'inputs' expression must resolve to an array"),m(ft(o),"'useLongestLength' must be a boolean"),y(r.defaults)&&m(o,"'useLongestLength' must be set to true to use 'defaults'");let s=0;for(let a of e){if(l(a))return null;m(y(a),"'inputs' expression values must resolve to an array or null"),s=o?Math.max(s,a.length):Math.min(s||a.length,a.length)}let p=[],i=r.defaults||[];for(let a=0;a<s;a++){let c=e.map((f,A)=>l(f[a])?i[A]||null:f[a]);p.push(c)}return p};function Vt(t,r,n,e){m(y(r),"expression must be an array.");let o=u(t,r,null,n);return o.some(l)?null:(m(o.every(d),"expression must evalue to array of numbers."),e(o))}var As=(t,r,n)=>Vt(t,r,n,e=>e.reduce((o,s)=>o&s,-1));var bs=(t,r,n)=>{let e=u(t,r,null,n);return l(e)?null:(m(d(e),"$bitNot: expression must evaluate to a number."),~e)};var ds=(t,r,n)=>Vt(t,r,n,e=>e.reduce((o,s)=>o|s,0));var xs=(t,r,n)=>Vt(t,r,n,e=>e.reduce((o,s)=>o^s,0));var nr={};lt(nr,{$and:()=>An,$not:()=>bn,$or:()=>dn});var An=(t,r,n)=>{let e=u(t,r,null,n);return L(e,n.useStrictMode)&&e.every(o=>L(o,n.useStrictMode))};var bn=(t,r,n)=>{let e=et(r);return e.length==0?!1:(m(e.length==1,"Expression $not takes exactly 1 argument"),!u(t,e[0],null,n))};var dn=(t,r,n)=>{let e=u(t,r,null,n),o=n.useStrictMode;return L(e,o)&&e.some(s=>L(s,o))};var or={};lt(or,{$cmp:()=>xn,$eq:()=>gn,$gt:()=>hn,$gte:()=>jn,$lt:()=>En,$lte:()=>$n,$ne:()=>In});var xn=(t,r,n)=>{let e=u(t,r,null,n);return m(y(e)&&e.length==2,"$cmp: expression must resolve to array of size 2."),w(e[0],e[1])};var gn=(t,r,n)=>rt(t,r,n,er);var hn=(t,r,n)=>rt(t,r,n,Sr);var jn=(t,r,n)=>rt(t,r,n,Cr);var En=(t,r,n)=>rt(t,r,n,Nr);var $n=(t,r,n)=>rt(t,r,n,kr);var In=(t,r,n)=>rt(t,r,n,Tr);var gs=(t,r,n)=>{let e,o,s,p="$cond: invalid arguments";y(r)?(m(r.length===3,p),e=r[0],o=r[1],s=r[2]):(m(j(r),p),e=r.if,o=r.then,s=r.else);let i=L(u(t,e,null,n),n.useStrictMode);return u(t,i?o:s,null,n)};var le=(t,r,n)=>{let e=u(t,r,null,n);return e.find(o=>!l(o))??e[e.length-1]};var hs=(t,r,n)=>{let e=null;return r.branches.some(o=>{let s=L(u(t,o.case,null,n),n.useStrictMode);return s&&(e=o.then),s}),u(t,e!==null?e:r.default,null,n)};var fe=(t,r,n)=>{m(n.scriptEnabled,"$function operator requires 'scriptEnabled' option to be true");let e=u(t,r,null,n);return e.body.apply(null,e.args)};var js=["mon","mon","tue","wed","thu","fri","sat","sun"],Es=-1e9,Wt=7,ye=t=>(t&3)==0&&(t%100!=0||t%400==0),$s=[365,366],Is=[[0,31,59,90,120,151,181,212,243,273,304,334],[0,31,60,91,121,152,182,213,244,274,305,335]],sr=t=>Is[+ye(t.getUTCFullYear())][t.getUTCMonth()]+t.getUTCDate(),Dr=(t,r)=>{let n=t.getUTCDay()||7,e=r.toLowerCase().substring(0,3);return(n-js.lastIndexOf(e)+Wt)%Wt},Tn=t=>(t+Math.floor(t/4)-Math.floor(t/100)+Math.floor(t/400))%7,wn=t=>52+ +(Tn(t)==4||Tn(t-1)==3);function Bt(t){let r=t.getUTCDay()||7,n=Math.floor((10+sr(t)-r)/7);return n<1?wn(t.getUTCFullYear()-1):n>wn(t.getUTCFullYear())?1:n}function Mr(t){return t.getUTCFullYear()-+(t.getUTCMonth()===0&&t.getUTCDate()==1&&t.getUTCDay()<1)}var jt=60,mt={week:6048e5,day:864e5,hour:36e5,minute:6e4,second:1e3,millisecond:1},Pr="%Y-%m-%dT%H:%M:%S.%LZ",Oe=[["year",0,9999],["month",1,12],["day",1,31],["hour",0,23],["minute",0,59],["second",0,59],["millisecond",0,999]];var Lt={"%b":{name:"abbr_month",padding:3,re:/(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)/i},"%B":{name:"full_month",padding:0,re:/(January|February|March|April|May|June|July|August|September|October|November|December)/i},"%Y":{name:"year",padding:4,re:/([0-9]{4})/},"%G":{name:"year",padding:4,re:/([0-9]{4})/},"%m":{name:"month",padding:2,re:/(0[1-9]|1[012])/},"%d":{name:"day",padding:2,re:/(0[1-9]|[12][0-9]|3[01])/},"%j":{name:"day_of_year",padding:3,re:/(0[0-9][1-9]|[12][0-9]{2}|3[0-5][0-9]|36[0-6])/},"%H":{name:"hour",padding:2,re:/([01][0-9]|2[0-3])/},"%M":{name:"minute",padding:2,re:/([0-5][0-9])/},"%S":{name:"second",padding:2,re:/([0-5][0-9]|60)/},"%L":{name:"millisecond",padding:3,re:/([0-9]{3})/},"%w":{name:"day_of_week",padding:1,re:/([0-6])/},"%u":{name:"day_of_week_iso",padding:1,re:/([1-7])/},"%U":{name:"week_of_year",padding:2,re:/([1-4][0-9]?|5[0-3]?)/},"%V":{name:"week_of_year_iso",padding:2,re:/([1-4][0-9]?|5[0-3]?)/},"%z":{name:"timezone",padding:2,re:/(([+-][01][0-9]|2[0-3]):?([0-5][0-9])?)/},"%Z":{name:"minute_offset",padding:3,re:/([+-][0-9]{3})/},"%%":{name:"percent_literal",padding:1,re:/%%/}},Rr=/(%[bBYGmdjHMSLwuUVzZ%])/g,Sn=/%[bBYGmdjHMSLwuUVzZ%]/,Ts=/^[a-zA-Z_]+\/[a-zA-Z_]+$/;function it(t){if(l(t))return 0;if(Ts.test(t)){let o=new Date,s=new Date(o.toLocaleString("en-US",{timeZone:"UTC"}));return(new Date(o.toLocaleString("en-US",{timeZone:t})).getTime()-s.getTime())/6e4}let r=Lt["%z"].re.exec(t);m(!!r,`timezone '${t}' is invalid or not supported.`);let n=parseInt(r[2])||0,e=parseInt(r[3])||0;return(Math.abs(n*jt)+e)*(n<0?-1:1)}function Cn(t){return(t<0?"-":"+")+_r(Math.abs(Math.floor(t/jt)),2)+_r(Math.abs(t)%jt,2)}function at(t,r){t.setUTCMinutes(t.getUTCMinutes()+r)}function P(t,r,n){if(S(t))return t;let e=u(t,r,null,n);if(S(e))return new Date(e);if(d(e))return new Date(e*1e3);m(!!e?.date,`cannot convert ${JSON.stringify(r)} to date`);let o=S(e.date)?new Date(e.date):new Date(e.date*1e3);return e.timezone&&at(o,it(e.timezone)),o}function _r(t,r){return new Array(Math.max(r-String(t).length+1,0)).join("0")+t.toString()}var Nn=t=>{let r=t-Es;return Math.trunc(r/4)-Math.trunc(r/100)+Math.trunc(r/400)};function ws(t,r){return Math.trunc(Nn(r-1)-Nn(t-1)+(r-t)*$s[0])}var zt=(t,r)=>r.getUTCFullYear()-t.getUTCFullYear(),Ur=(t,r)=>r.getUTCMonth()-t.getUTCMonth()+zt(t,r)*12,Fr=(t,r)=>{let n=Math.trunc(t.getUTCMonth()/3);return Math.trunc(r.getUTCMonth()/3)-n+zt(t,r)*4},Qt=(t,r)=>sr(r)-sr(t)+ws(t.getUTCFullYear(),r.getUTCFullYear()),Vr=(t,r,n)=>{let e=(n||"sun").substring(0,3);return Math.trunc((Qt(t,r)+Dr(t,e)-Dr(r,e))/Wt)},vn=(t,r)=>r.getUTCHours()-t.getUTCHours()+Qt(t,r)*24,kn=(t,r)=>{let n=t.getUTCMonth()+r,e=Math.floor(n/12);if(n<0){let o=n%12+12;t.setUTCFullYear(t.getUTCFullYear()+e,o,t.getUTCDate())}else t.setUTCFullYear(t.getUTCFullYear()+e,n%12,t.getUTCDate())},Wr=(t,r,n,e)=>{let o=new Date(t);switch(r){case"year":o.setUTCFullYear(o.getUTCFullYear()+n);break;case"quarter":kn(o,3*n);break;case"month":kn(o,n);break;default:o.setTime(o.getTime()+mt[r]*n)}return o};var Nt=(t,r,n)=>{let e=u(t,r,null,n);return Wr(e.startDate,e.unit,e.amount,e.timezone)};var Ns=(t,r,n)=>{let{startDate:e,endDate:o,unit:s,timezone:p,startOfWeek:i}=u(t,r,null,n),a=new Date(e),c=new Date(o),f=it(p);switch(at(a,f),at(c,f),s){case"year":return zt(a,c);case"quarter":return Fr(a,c);case"month":return Ur(a,c);case"week":return Vr(a,c,i);case"day":return Qt(a,c);case"hour":return vn(a,c);case"minute":return a.setUTCSeconds(0),a.setUTCMilliseconds(0),c.setUTCSeconds(0),c.setUTCMilliseconds(0),Math.round((c.getTime()-a.getTime())/mt[s]);default:return Math.round((c.getTime()-a.getTime())/mt[s])}};var ks=[31,28,31,30,31,30,31,31,30,31,30,31],Ss=t=>t.month==2&&ye(t.year)?29:ks[t.month-1],Cs=(t,r,n)=>{let e=u(t,r,null,n),o=it(e.timezone);for(let s=Oe.length-1,p=0;s>=0;s--){let i=Oe[s],a=i[0],c=i[1],f=i[2],A=(e[a]||0)+p;p=0;let O=f+1;if(a=="hour"&&(A+=Math.floor(o/jt)*-1),a=="minute"&&(A+=o%jt*-1),A<c){let b=c-A;p=-1*Math.ceil(b/O),A=O-b%O}else A>f&&(A+=c,p=Math.trunc(A/O),A%=O);e[a]=A}return e.day=Math.min(e.day,Ss(e)),new Date(Date.UTC(e.year,e.month-1,e.day,e.hour,e.minute,e.second,e.millisecond))};function vs(t){return t==="Z"?0:t>="A"&&t<"N"?t.charCodeAt(0)-64:77-t.charCodeAt(0)}var Ds=t=>t.replace(/^\//,"").replace(/\/$/,""),_s=["^",".","-","*","?","$"];function Ms(t){return _s.forEach(r=>{t=t.replace(r,`\\${r}`)}),t}var Ps=(t,r,n)=>{let e=u(t,r,null,n);e.format=e.format||Pr,e.onNull=e.onNull||null;let o=e.dateString;if(l(o))return e.onNull;let s=e.format.split(Sn);s.reverse();let p=e.format.match(Rr),i={},a="";for(let O=0,b=p.length;O<b;O++){let x=p[O],g=Lt[x];if(j(g)){let T=g.re.exec(o),$=s.pop()||"";T!==null?(i[g.name]=/^\d+$/.exec(T[0])?parseInt(T[0]):T[0],o=o.substring(T.index+T[0].length+1),a+=Ms($)+Ds(g.re.toString())):i[g.name]=null}}if(l(i.year)||l(i.month)||l(i.day)||!new RegExp("^"+a+"[A-Z]?$").exec(e.dateString))return e.onError;let c=e.dateString.match(/([A-Z])$/);m(!(c&&e.timezone),`$dateFromString: you cannot pass in a date/time string with time zone information ('${c&&c[0]}') together with a timezone argument`);let f=c?vs(c[0])*jt:it(e.timezone),A=new Date(Date.UTC(i.year,i.month-1,i.day,0,0,0));return l(i.hour)||A.setUTCHours(i.hour),l(i.minute)||A.setUTCMinutes(i.minute),l(i.second)||A.setUTCSeconds(i.second),l(i.millisecond)||A.setUTCMilliseconds(i.millisecond),at(A,-f),A};var Rs=(t,r,n)=>{let e=u(t,r?.amount,null,n);return Nt(t,{...r,amount:-1*e},n)};var Us=(t,r,n)=>{let e=u(t,r,null,n),o=new Date(e.date),s=it(e.timezone);at(o,s);let p={hour:o.getUTCHours(),minute:o.getUTCMinutes(),second:o.getUTCSeconds(),millisecond:o.getUTCMilliseconds()};return e.iso8601==!0?Object.assign(p,{isoWeekYear:Mr(o),isoWeek:Bt(o),isoDayOfWeek:o.getUTCDay()||7}):Object.assign(p,{year:o.getUTCFullYear(),month:o.getUTCMonth()+1,day:o.getUTCDate()})};var Ae=(t,r,n)=>P(t,r,n).getUTCDate();var be=(t,r,n)=>P(t,r,n).getUTCDay()+1;var de=(t,r,n)=>sr(P(t,r,n));var xe=(t,r,n)=>P(t,r,n).getUTCHours();var ge=(t,r,n)=>P(t,r,n).getUTCDay()||7;var he=(t,r,n)=>Bt(P(t,r,n));var je=(t,r,n)=>P(t,r,n).getUTCMilliseconds();var Ee=(t,r,n)=>P(t,r,n).getUTCMinutes();var $e=(t,r,n)=>P(t,r,n).getUTCMonth()+1;var Ie=(t,r,n)=>P(t,r,n).getUTCSeconds();var Te=(t,r,n)=>{let e=P(t,r,n),o=Bt(e);return e.getUTCDay()>0&&e.getUTCDate()==1&&e.getUTCMonth()==0?0:e.getUTCDay()==0?o+1:o};var Br=(t,r,n)=>P(t,r,n).getUTCFullYear();var Fs={"%Y":Br,"%G":Br,"%m":$e,"%d":Ae,"%H":xe,"%M":Ee,"%S":Ie,"%L":je,"%u":ge,"%U":Te,"%V":he,"%j":de,"%w":(t,r,n)=>be(t,r,n)-1},we=(t,r,n)=>{let e=u(t,r,null,n);if(l(e.onNull)&&(e.onNull=null),l(e.date))return e.onNull;let o=P(t,e.date,n),s=e.format||Pr,p=it(e.timezone),i=s.match(Rr);at(o,p);for(let a=0,c=i.length;a<c;a++){let f=i[a];m(f in Lt,`$dateToString: invalid format specifier ${f}`);let{name:A,padding:O}=Lt[f],b=Fs[f],x;if(b)x=_r(b(t,o,n),O);else switch(A){case"timezone":x=Cn(p);break;case"minute_offset":x=p.toString();break;case"abbr_month":case"full_month":{let g=A.startsWith("abbr")?"short":"long";x=o.toLocaleString("en-US",{month:g});break}}s=s.replace(f,x)}return s};var ir=["year","quarter","month","week","day","hour","minute","second","millisecond"];var Dn=9466848e5,_n=(t,r)=>{let n=t%r;return n<0&&(n+=r),n},Vs={day:Qt,month:Ur,quarter:Fr,year:zt},Ws=/(mon(day)?|tue(sday)?|wed(nesday)?|thu(rsday)?|fri(day)?|sat(urday)?|sun(day)?)/i,Bs=(t,r,n)=>{let{date:e,unit:o,binSize:s,timezone:p,startOfWeek:i}=u(t,r,null,n);if(l(e)||l(o))return null;let a=(i??"sun").toLowerCase().substring(0,3);m(S(e),"$dateTrunc: 'date' must resolve to a valid Date object."),m(ir.includes(o),"$dateTrunc: unit is invalid."),m(o!="week"||Ws.test(a),`$dateTrunc: startOfWeek '${a}' is not a valid.`),m(l(s)||s>0,"$dateTrunc requires 'binSize' to be greater than 0, but got value 0.");let c=s??1;switch(o){case"millisecond":case"second":case"minute":case"hour":{let f=c*mt[o],A=e.getTime()-Dn;return new Date(e.getTime()-_n(A,f))}default:{m(c<=1e11,"dateTrunc unsupported binSize value");let f=new Date(e),A=new Date(Dn),O=0;if(o=="week"){let T=Dr(A,a),$=(Wt-T)%Wt;A.setTime(A.getTime()+$*mt.day),O=Vr(A,f,a)}else O=Vs[o](A,f);let b=O-_n(O,c),x=Wr(A,o,b,p),g=it(p);return at(x,-g),x}}};var Ls=(t,r,n)=>Mr(P(t,r,n));var zs=(t,r,n)=>r;var Qs=(t,r,n)=>{let e=u(t,r.input,null,n);return ne(e,{input:"$$CURRENT"},n)};var qs=(t,r,n)=>{let e=u(t,r,null,n),[o,s]=j(e)?[e.field,e.input||t]:[e,t];return l(s)?null:(m(j(s),"$getField expression 'input' must evaluate to an object"),m(h(o),"$getField expression 'field' must evaluate to a string"),s[o])};var Ks=(t,r,n)=>Math.random();var Ys=(t,r,n)=>Math.random()<=u(t,r,null,n);var Ne=(t,r,n)=>{let e=u(t,r,null,n)??[];return oe(e,r,n)};var Hs=(t,r,n)=>{let e=u(t,r,null,n);if(l(e))return null;m(j(e),`$objectToArray requires a document input, found: ${Q(e)}`);let o=Object.entries(e),s=new Array(o.length),p=0;for(let[i,a]of o)s[p++]={k:i,v:a};return s};var ke=(t,r,n)=>{let{input:e,field:o,value:s}=u(t,r,null,n);if(l(e))return null;m(j(e),"$setField expression 'input' must evaluate to an object"),m(h(o),"$setField expression 'field' must evaluate to a string");let p={...e};return r.value=="$$REMOVE"?delete p[o]:p[o]=s,p};var Gs=(t,r,n)=>ke(t,{...r,value:"$$REMOVE"},n);var Js=(t,r,n)=>{let e=u(t,r.input,null,n);return tr(e,{...r,input:"$$CURRENT"},n)};var Xs=(t,r,n)=>u(t,r,null,n)[0].every(o=>L(o,n.useStrictMode));var Zs=(t,r,n)=>u(t,r,null,n)[0].some(o=>L(o,n.useStrictMode));var ti=(t,r,n)=>{let e=u(t,r,null,n);if(l(e)||(m(y(e),"$setDifference must be an arrays."),e.some(l)))return null;m(e.length==2,"$setDifference takes exactly 2 arguments."),m(e.every(y),"$setDifference operands must be arrays.");let o=q.init(n.hashFunction);return e[0].forEach(s=>o.set(s,!0)),e[1].forEach(s=>o.delete(s)),Array.from(o.keys())};var ri=(t,r,n)=>{let e=u(t,r,null,n);m(y(e)&&e.every(y),"$setEquals operands must be arrays.");let o=q.init();e[0].every((s,p)=>o.set(s,p));for(let s=1;s<e.length;s++){let p=e[s],i=new Set;for(let a=0;a<p.length;a++){let c=o.get(p[a])??-1;if(c===-1)return!1;i.add(c)}if(i.size!==o.size)return!1}return!0};var ei=(t,r,n)=>{let e=u(t,r,null,n);return l(e)?null:(m(y(e)&&e.every(y),"$setIntersection operands must be arrays."),Mt(e,n?.hashFunction))};var ni=(t,r,n)=>{let e=u(t,r,null,n);m(y(e)&&e.every(y),"$setIsSubset operands must be arrays.");let o=e[0],s=e[1],p=q.init(),i=new Set;o.every((a,c)=>p.set(a,c));for(let a of s)if(i.add(p.get(a)??-1),i.size>p.size)return!0;return i.delete(-1),i.size==p.size};var oi=(t,r,n)=>{let e=u(t,r,null,n);return l(e)||(m(y(e),"$setUnion operands must be arrays."),e.some(l))?null:Pt(nt(e),n?.hashFunction)};var si=(t,r,n)=>{let e=u(t,r,null,n);return m(e.every(o=>h(o)||l(o)),"$concat only supports strings."),e.some(l)?null:e.join("")};var ii=(t,r,n)=>{let e=u(t,r,null,n),o="$indexOfBytes expression resolves to invalid an argument";if(l(e[0]))return null;m(h(e[0])&&h(e[1]),o);let s=e[0],p=e[1],i=e[2],a=e[3],c=l(i)||d(i)&&i>=0&&Math.round(i)===i;if(c=c&&(l(a)||d(a)&&a>=0&&Math.round(a)===a),m(c,o),i=i||0,a=a||s.length,i>a)return-1;let f=s.substring(i,a).indexOf(p);return f>-1?f+i:f};var pi=[0,32,9,10,11,12,13,160,5760,8192,8193,8194,8195,8196,8197,8198,8199,8200,8201,8202];function qt(t,r,n,e){let o=u(t,r,null,n),s=o.input;if(l(s))return null;let p=l(o.chars)?pi:o.chars.split("").map(c=>c.codePointAt(0)),i=0,a=s.length-1;for(;e.left&&i<=a&&p.indexOf(s[i].codePointAt(0))!==-1;)i++;for(;e.right&&i<=a&&p.indexOf(s[a].codePointAt(0))!==-1;)a--;return s.substring(i,a+1)}function Kt(t,r,n,e){let o=u(t,r,null,n);if(!h(o.input))return[];let s=o.options;s&&(m(s.indexOf("x")===-1,"extended capability option 'x' not supported"),m(s.indexOf("g")===-1,"global option 'g' not supported"));let p=o.input,i=new RegExp(o.regex,s),a,c=new Array,f=0;for(;a=i.exec(p);){let A={match:a[0],idx:a.index+f,captures:[]};for(let O=1;O<a.length;O++)A.captures.push(a[O]||null);if(c.push(A),!e.global)break;f=a.index+a[0].length,p=p.substring(f)}return c}var ai=(t,r,n)=>qt(t,r,n,{left:!0,right:!1});var mi=(t,r,n)=>{let e=Kt(t,r,n,{global:!1});return e&&e.length>0?e[0]:null};var ui=(t,r,n)=>Kt(t,r,n,{global:!0});var ci=(t,r,n)=>Kt(t,r,n,{global:!1}).length!=0;var li=(t,r,n)=>{let e=u(t,r,null,n),o=[e.input,e.find,e.replacement];return o.some(l)?null:(m(o.every(h),"$replaceAll expression fields must evaluate to string"),e.input.replace(new RegExp(e.find,"g"),e.replacement))};var fi=(t,r,n)=>{let e=u(t,r,null,n),o=[e.input,e.find,e.replacement];return o.some(l)?null:(m(o.every(h),"$replaceOne expression fields must evaluate to string"),e.input.replace(e.find,e.replacement))};var yi=(t,r,n)=>qt(t,r,n,{left:!1,right:!0});var Oi=(t,r,n)=>{let e=u(t,r,null,n);return l(e[0])?null:(m(e.every(h),"$split expression must result to array(2) of strings"),e[0].split(e[1]))};var Ai=(t,r,n)=>{let e=u(t,r,null,n),o=e[0],s=e[1];return B(o,s)||e.every(l)?0:(m(e.every(h),"$strcasecmp must resolve to array(2) of strings"),o=o.toUpperCase(),s=s.toUpperCase(),o>s&&1||o<s&&-1||0)};var bi=(t,r,n)=>~-encodeURI(u(t,r,null,n)).split(/%..|./).length;var di=(t,r,n)=>u(t,r,null,n).length;var Se=(t,r,n)=>{let[e,o,s]=u(t,r,null,n);return o<0||!h(e)?"":s<0?e.substring(o):e.substring(o,o+s)};var xi=[192,224,240];function gi(t){if(t<128)return[t];let r=t<2048&&1||t<65536&&2||3,n=xi[r-1],e=[(t>>6*r)+n];for(;r>0;)e.push(128|t>>6*--r&63);return e}function hi(t){let r=[];for(let n=0,e=t.length;n<e;n++)r.push(gi(t.codePointAt(n)));return r}var ji=(t,r,n)=>{let e=u(t,r,null,n),o=e[0],s=e[1],p=e[2];m(h(o)&&d(s)&&s>=0&&d(p)&&p>=0,"$substrBytes: invalid arguments");let i=hi(o),a=[],c=0;for(let O=0;O<i.length;O++)a.push(c),c+=i[O].length;let f=a.indexOf(s),A=a.indexOf(s+p);return m(f>-1&&A>-1,"$substrBytes: invalid range, start or end index is a UTF-8 continuation byte."),o.substring(f,A)};var Ei=(t,r,n)=>Se(t,r,n);var $i=(t,r,n)=>{let e=u(t,r,null,n);return Y(e)?"":e.toLowerCase()};var Ii=(t,r,n)=>{let e=u(t,r,null,n);return Y(e)?"":e.toUpperCase()};var Ti=(t,r,n)=>qt(t,r,n,{left:!0,right:!0});var wi=(t,r,n)=>Zt(u(t,r,null,n),n.hashFunction);function R(t,r,n,e,o){let s={undefined:null,null:null,NaN:NaN,Infinity:new Error,"-Infinity":new Error,...o},p=u(t,r,null,n);if(p in s){let i=s[p],a=i instanceof Error;return m(!a,`$${e.name}: value must be in range (-inf,inf)`),!a&&i}return e(p)}var Ni=(t,r,n)=>R(t,r,n,Math.acos,{Infinity:1/0,0:new Error});var ki=(t,r,n)=>R(t,r,n,Math.acosh,{Infinity:1/0,0:new Error});var Si=(t,r,n)=>R(t,r,n,Math.asin);var Ci=(t,r,n)=>R(t,r,n,Math.asinh,{Infinity:1/0,"-Infinity":-1/0});var vi=(t,r,n)=>R(t,r,n,Math.atan);var Di=(t,r,n)=>{let[e,o]=u(t,r,null,n);return isNaN(e)||l(e)?e:isNaN(o)||l(o)?o:Math.atan2(e,o)};var _i=(t,r,n)=>R(t,r,n,Math.atanh,{1:1/0,"-1":-1/0});var Mi=(t,r,n)=>R(t,r,n,Math.cos);var Pi=(t,r,n)=>R(t,r,n,Math.cosh,{"-Infinity":1/0,Infinity:1/0});var Ri=t=>t*(Math.PI/180),Ui=(t,r,n)=>R(t,r,n,Ri,{Infinity:1/0,"-Infinity":1/0});var Fi=t=>t*(180/Math.PI),Vi=(t,r,n)=>R(t,r,n,Fi,{Infinity:1/0,"-Infinity":1/0});var Wi=(t,r,n)=>R(t,r,n,Math.sin);var Bi=(t,r,n)=>R(t,r,n,Math.sinh,{"-Infinity":-1/0,Infinity:1/0});var Li=(t,r,n)=>R(t,r,n,Math.tan);var zi=(t,r,n)=>R(t,r,n,Math.tanh,{Infinity:1,"-Infinity":-1});var Ce=(t,r,n)=>{let e=u(t,r,null,n);return l(e)?null:h(e)?!0:!!e};var ve=(t,r,n)=>{let e=u(t,r,null,n);if(S(e))return e;if(l(e))return null;let o=new Date(e);return m(!isNaN(o.getTime()),`cannot convert '${e}' to date`),o};var pr=(t,r,n)=>{let e=u(t,r,null,n);if(l(e))return null;if(S(e))return e.getTime();if(e===!0)return 1;if(e===!1)return 0;let o=Number(e);return m(d(o),`cannot convert '${e}' to double/decimal`),o};var ar=2147483647,Lr=-2147483648,Mn=9007199254740991,Pn=-9007199254740991;function zr(t,r,n,e,o){let s=u(t,r,null,n);if(s===!0)return 1;if(s===!1)return 0;if(l(s))return null;if(S(s))return s.getTime();let p=Number(s);return m(d(p)&&p>=e&&p<=o&&(!h(s)||p.toString().indexOf(".")===-1),`cannot convert '${s}' to ${o==ar?"int":"long"}`),Math.trunc(p)}var De=(t,r,n)=>zr(t,r,n,Lr,ar);var _e=(t,r,n)=>zr(t,r,n,Pn,Mn);var Me=(t,r,n)=>{let e=u(t,r,null,n);return l(e)?null:S(e)?we(t,{date:r,format:"%Y-%m-%dT%H:%M:%S.%LZ"},n):e.toString()};var Qi=(t,r,n)=>{let e=u(t,r,null,n);if(e.onNull=e.onNull===void 0?null:e.onNull,l(e.input))return e.onNull;try{switch(e.to){case 2:case"string":return Me(t,e.input,n);case 8:case"boolean":case"bool":return Ce(t,e.input,n);case 9:case"date":return ve(t,e.input,n);case 1:case 19:case"double":case"decimal":case"number":return pr(t,e.input,n);case 16:case"int":return De(t,e.input,n);case 18:case"long":return _e(t,e.input,n)}}catch{}return m(e.onError!==void 0,`could not convert to type ${e.to}.`),e.onError};var qi=(t,r,n)=>{let e=u(t,r,null,n);return d(e)};var Ki=pr;var Yi=(t,r,n)=>{let e=u(t,r,null,n);if(n.useStrictMode){if(e===void 0)return"missing";if(e===!0||e===!1)return"bool";if(d(e))return e%1!=0?"double":e>=Lr&&e<=ar?"int":"long";if(H(e))return"regex"}return Q(e)};var Hi=(t,r,n)=>{let e={};for(let[o,s]of Object.entries(r.vars))e[o]=u(t,s,null,n);return u(t,r.in,null,I.init(n,t,{variables:e}))};var Le={};lt(Le,{$addFields:()=>kt,$bucket:()=>Gi,$bucketAuto:()=>Ji,$count:()=>ep,$densify:()=>np,$documents:()=>Re,$facet:()=>op,$fill:()=>mp,$graphLookup:()=>up,$group:()=>ur,$limit:()=>pe,$lookup:()=>We,$match:()=>Tp,$merge:()=>wp,$out:()=>Np,$project:()=>rr,$redact:()=>kp,$replaceRoot:()=>Sp,$replaceWith:()=>Cp,$sample:()=>vp,$set:()=>Dp,$setWindowFields:()=>Ve,$skip:()=>ae,$sort:()=>Z,$sortByCount:()=>_p,$unionWith:()=>Mp,$unset:()=>Pp,$unwind:()=>Rp});var kt=(t,r,n)=>{let e=Object.keys(r);return e.length===0?t:t.map((o=>{let s={...o};for(let p of e){let i=u(o,r[p],null,n);i!==void 0?ht(s,p,i):It(s,p)}return s}))};var Gi=(t,r,n)=>{let e=[...r.boundaries],o=r.default,s=e[0],p=e[e.length-1],i=r.output||{count:{$sum:1}};m(e.length>1,"$bucket: must specify at least two boundaries.");let a=e.every((A,O)=>O===0||Q(A)===Q(e[O-1])&&w(A,e[O-1])>0);m(a,"$bucket: bounds must be of same type and in ascending order"),m(l(o)||Q(o)!==Q(s)||w(o,p)>=0||w(o,s)<0,"$bucket: 'default' expression must be out of boundaries range");let c=()=>{let A=new Map;for(let O=0;O<e.length-1;O++)A.set(e[O],[]);return l(o)||A.set(o,[]),t.each(O=>{let b=u(O,r.groupBy,null,n);if(l(b)||w(b,s)<0||w(b,p)>=0)m(!l(o),"$bucket require a default for out of range values"),A.get(o).push(O);else{m(w(b,s)>=0&&w(b,p)<0,"$bucket 'groupBy' expression must resolve to a value in range of boundaries");let x=Ut(e,b),g=e[Math.max(0,x-1)];A.get(g).push(O)}}),e.pop(),l(o)||(A.get(o).length?e.push(o):A.delete(o)),m(A.size===e.length,"bounds and groups must be of equal size."),N(e).map(O=>({...u(A.get(O),i,null,n),_id:O}))},f;return N(()=>(f||(f=c()),f.next()))};var Ji=(t,r,n)=>{let{buckets:e,groupBy:o,output:s,granularity:p}=r,i=s??{count:{$sum:1}};m(e>0,`$bucketAuto: 'buckets' field must be greater than 0, but found: ${e}`),p&&m(/^(POWERSOF2|1-2-5|E(6|12|24|48|96|192)|R(5|10|20|40|80))$/.test(p),`$bucketAuto: invalid granularity '${p}'.`);let a=new Map,c=p?(b,x)=>{}:(b,x)=>a.set(b,x),f=t.map(b=>{let x=u(b,o,null,n)??null;return m(!p||d(x),"$bucketAuto: groupBy values must be numeric when granularity is specified."),c(b,x??null),[x??null,b]}).value();f.sort((b,x)=>l(b[0])?-1:l(x[0])?1:w(b[0],x[0]));let A;p?p=="POWERSOF2"?A=Zi(f,e):A=rp(f,e,p):A=Xi(f,e,a);let O=!1;return N(()=>{if(O)return{done:!0};let{min:b,max:x,bucket:g,done:T}=A();O=T;let $=u(g,i,null,n);for(let[D,W]of Object.entries($))y(W)&&($[D]=W.filter(z=>z!==void 0));return{done:!1,value:{...$,_id:{min:b,max:x}}}})};function Xi(t,r,n){let e=t.length,o=Math.max(1,Math.round(t.length/r)),s=0,p=0;return()=>{let i=++p==r,a=new Array;for(;s<e&&(i||a.length<o||s>0&&B(t[s-1][0],t[s][0]));)a.push(t[s++][1]);let c=n.get(a[0]),f;return s<e?f=t[s][0]:f=n.get(a[a.length-1]),m(l(f)||l(c)||c<=f,"error: $bucketAuto boundary must be in order."),{min:c,max:f,bucket:a,done:s>=e}}}function Zi(t,r){let n=t.length,e=Math.max(1,Math.round(t.length/r)),o=a=>a===0?0:2**(Math.floor(Math.log2(a))+1),s=0,p=0,i=0;return()=>{let a=new Array,c=o(i);for(p=s>0?i:0;a.length<e&&s<n&&(i===0||t[s][0]<c);)a.push(t[s++][1]);for(i=i==0?o(t[s-1][0]):c;s<n&&t[s][0]<i;)a.push(t[s++][1]);return{min:p,max:i,bucket:a,done:s>=n}}}var tp={R5:[10,16,25,40,63],R10:[100,125,160,200,250,315,400,500,630,800],R20:[100,112,125,140,160,180,200,224,250,280,315,355,400,450,500,560,630,710,800,900],R40:[100,106,112,118,125,132,140,150,160,170,180,190,200,212,224,236,250,265,280,300,315,355,375,400,425,450,475,500,530,560,600,630,670,710,750,800,850,900,950],R80:[103,109,115,122,128,136,145,155,165,175,185,195,206,218,230,243,258,272,290,307,325,345,365,387,412,437,462,487,515,545,575,615,650,690,730,775,825,875,925,975],"1-2-5":[10,20,50],E6:[10,15,22,33,47,68],E12:[10,12,15,18,22,27,33,39,47,56,68,82],E24:[10,11,12,13,15,16,18,20,22,24,27,30,33,36,39,43,47,51,56,62,68,75,82,91],E48:[100,105,110,115,121,127,133,140,147,154,162,169,178,187,196,205,215,226,237,249,261,274,287,301,316,332,348,365,383,402,422,442,464,487,511,536,562,590,619,649,681,715,750,787,825,866,909,953],E96:[100,102,105,107,110,113,115,118,121,124,127,130,133,137,140,143,147,150,154,158,162,165,169,174,178,182,187,191,196,200,205,210,215,221,226,232,237,243,249,255,261,267,274,280,287,294,301,309,316,324,332,340,348,357,365,374,383,392,402,412,422,432,442,453,464,475,487,499,511,523,536,549,562,576,590,604,619,634,649,665,681,698,715,732,750,768,787,806,825,845,866,887,909,931,953,976],E192:[100,101,102,104,105,106,107,109,110,111,113,114,115,117,118,120,121,123,124,126,127,129,130,132,133,135,137,138,140,142,143,145,147,149,150,152,154,156,158,160,162,164,165,167,169,172,174,176,178,180,182,184,187,189,191,193,196,198,200,203,205,208,210,213,215,218,221,223,226,229,232,234,237,240,243,246,249,252,255,258,261,264,267,271,274,277,280,284,287,291,294,298,301,305,309,312,316,320,324,328,332,336,340,344,348,352,357,361,365,370,374,379,383,388,392,397,402,407,412,417,422,427,432,437,442,448,453,459,464,470,475,481,487,493,499,505,511,517,523,530,536,542,549,556,562,569,576,583,590,597,604,612,619,626,634,642,649,657,665,673,681,690,698,706,715,723,732,741,750,759,768,777,787,796,806,816,825,835,845,856,866,876,887,898,909,920,931,942,953,965,976,988]},Rn=(t,r)=>{if(t==0)return 0;let n=tp[r],e=n[0],o=n[n.length-1],s=1;for(;t>=o*s;)s*=10;let p=0;for(;t<e*s;)if(p=e*s,s/=10,t>=o*s)return p;m(t>=e*s&&t<o*s,"$bucketAuto: number out of range of series.");let i=Ut(n,t,(c,f)=>(f*=s,c<f?-1:c>f?1:0)),a=n[i]*s;return t==a?n[i+1]*s:a};function rp(t,r,n){let e=t.length,o=Math.max(1,Math.round(t.length/r)),s=0,p=0,i=0,a=0;return()=>{let c=++p==r,f=new Array;for(i=s>0?a:0;s<e&&(c||f.length<o);)f.push(t[s++][1]);a=Rn(t[s-1][0],n);let A=f.length;for(;s<e&&(c||t[s][0]<a);)f.push(t[s++][1]);return A!=f.length&&(a=Rn(t[s-1][0],n)),m(i<a,`$bucketAuto: ${i} < ${a}.`),{min:i,max:a,bucket:f,done:s>=e}}}var ep=(t,r,n)=>(m(h(r)&&!Y(r)&&r.indexOf(".")===-1&&r.trim()[0]!=="$","Invalid expression value for $count"),N([{[r]:t.size()}]));var np=(t,r,n)=>{let{step:e,bounds:o,unit:s}=r.range;s?(m(ir.includes(s),""),m(Number.isInteger(e)&&e>0,"The step parameter in a range statement must be a whole number when densifying a date range.")):m(d(e)&&e>0,"The step parameter in a range statement must be a strictly positive numeric value."),y(o)&&(m(!!o&&o.length===2,"A bounding array in a range statement must have exactly two elements."),m((o.every(d)||o.every(S))&&o[0]<o[1],"A bounding array must be an ascending array of either two dates or two numbers."),m(s&&!o.some(d),"Numeric bounds may not have unit parameter.")),r.partitionByFields&&m(y(r.partitionByFields),"$densify: `partitionByFields` must be an array of strings"),t=Z(t,{[r.field]:1},n);let p=I.init(n,null),i=_=>d(_)?_+e:Nt(null,{startDate:_,unit:s,amount:e},p),a=!!s&&ir.includes(s),c=_=>{let V=k(_,r.field);return m(l(V)||S(V)&&a||d(V)&&!a,"$densify: Densify field type must be numeric with 'unit' unspecified, or a date with 'unit' specified."),V},f=new Array,A=N(()=>{let _=t.next(),V=c(_.value);return l(V)?_:(f.push(_),{done:!0})}),O=q.init(n.hashFunction),[b,x]=y(o)?o:[o,o],g,T=_=>{g=g===void 0||g<_?_:g},$=[],D=N(()=>{let _=f.length>0?f.pop():t.next();if(_.done)return _;let V=$;y(r.partitionByFields)&&(V=r.partitionByFields.map($t=>k(_.value,$t)),m(V.every(h),"$densify: Partition fields must evaluate to string values.")),m(j(_.value),"$densify: collection must contain documents");let ct=c(_.value);O.has(V)||(b=="full"?(O.has($)||O.set($,ct),O.set(V,O.get($))):b=="partition"?O.set(V,ct):O.set(V,b));let K=O.get(V);if(ct<=K||x!="full"&&x!="partition"&&K>=x)return K<=ct&&O.set(V,i(K)),T(ct),_;O.set(V,i(K)),T(K);let At={[r.field]:K};return V&&V.forEach(($t,Ht)=>{At[r.partitionByFields[Ht]]=$t}),f.push(_),{done:!1,value:At}});if(b!=="full")return dt(A,D);let W=-1,z,ut=N(()=>{if(W===-1){let _=O.get($);O.delete($),z=Array.from(O.keys()),z.length===0&&(z.push($),O.set($,_)),W++}do{let _=z[W],V=O.get(_);if(V<g){O.set(_,i(V));let ct={[r.field]:V};return _.forEach((K,At)=>{ct[r.partitionByFields[At]]=K}),{done:!1,value:ct}}W++}while(W<z.length);return{done:!0}});return dt(A,D,ut)};var Re=(t,r,n)=>{let e=u(null,r,null,n);m(y(e),"$documents: expression must resolve to an array.");let o=N(e);return n.processingMode&3?o.map(G):o};var op=(t,r,n)=>t.transform((e=>{let o={};for(let[s,p]of Object.entries(r))o[s]=new pt(p,{...n,processingMode:1}).run(e);return[o]}));var mr=new WeakMap;function xt(t,r,n,e){mr.has(t)||mr.set(t,{});let o=mr.get(t);r.field in o||(o[r.field]=n());let s=!1;try{let p=e(o[r.field]);return s=!0,p}finally{s?r.documentNumber===t.length&&(delete o[r.field],Object.keys(o).length===0&&mr.delete(t)):mr.delete(t)}}function Qr(t,r,n,e,o){return xt(r,n,()=>{let s="$"+Object.keys(n.parentExpr.sortBy)[0],p=E(r,s,e),i=Rt(p,((f,A)=>p[A]),e.hashFunction),a=0,c=0;for(let f of i.keys()){let A=i.get(f).length;i.set(f,[a++,c]),c+=A}return{values:p,groups:i}},({values:s,groups:p})=>{if(p.size==r.length)return n.documentNumber;let i=s[n.documentNumber-1],[a,c]=p.get(i);return(o?a:c)+1})}var sp=(t,r,n,e,o)=>r+(o-t)*((e-r)/(n-t)),Ue=(t,r,n,e)=>xt(r,n,()=>{let o="$"+Object.keys(n.parentExpr.sortBy)[0],s=E(r,[o,n.inputExpr],e).filter((([a,c])=>d(+a)));if(s.length!==r.length)return null;let p=-1,i=0;for(;i<s.length;){for(;p+1<s.length&&d(s[p+1][1]);)p++,i=p;for(;i+1<s.length&&!d(s[i+1][1]);)i++;if(i+1>=s.length)break;for(i++;p+1<i;)s[p+1][1]=sp(s[p][0],s[p][1],s[i][0],s[i][1],s[p+1][0]),p++;p=i}return s.map(([a,c])=>c)},o=>o[n.documentNumber-1]);var Fe=(t,r,n,e)=>xt(r,n,()=>{let o=E(r,n.inputExpr,e);for(let s=1;s<o.length;s++)l(o[s])&&(o[s]=o[s-1]);return o},o=>o[n.documentNumber-1]);var qr="_id",ur=(t,r,n)=>{m(M(r,qr),"$group specification must include an '_id'");let e=r[qr],o=I.init(n),s=Object.keys(r).filter(p=>p!=qr);return t.transform((p=>{let i=Rt(p,f=>u(f,e,null,n),n.hashFunction),a=-1,c=Array.from(i.keys());return()=>{if(++a===i.size)return{done:!0};let f=c[a],A={};f!==void 0&&(A[qr]=f);for(let O of s)A[O]=u(i.get(f),r[O],null,o.update(null,{groupId:f}));return{value:A,done:!1}}}))};var Un=new Set(["$denseRank","$documentNumber","$first","$last","$linearFill","$rank","$shift"]),ip=new Set(["$denseRank","$expMovingAvg","$linearFill","$locf","$rank","$shift"]),pp=t=>{let r=t?.documents||t?.range;return!r||r[0]==="unbounded"&&r[1]==="unbounded"},Ve=(t,r,n)=>{n=yt(n),n.context.addExpressionOps({$function:fe});for(let e of Object.values(r.output)){let o=Object.keys(e),s=o.find(J);if(m(!!st("window",s,n)||!!st("accumulator",s,n),`'${s}' is not a valid window operator`),m(o.length>0&&o.length<=2&&(o.length==1||o.includes("window")),"'output' option should have a single window operator."),e?.window){let{documents:p,range:i}=e.window;m((+!!p^+!!i)===1,"'window' option supports only one of 'documents' or 'range'.")}}return r.sortBy&&(t=Z(t,r.sortBy,n)),t=ur(t,{_id:r.partitionBy,items:{$push:"$$CURRENT"}},n),t.transform((e=>{let o=[],s=[];for(let[p,i]of Object.entries(r.output)){let a=Object.keys(i).find(J),c={operatorName:a,func:{left:st("accumulator",a,n),right:st("window",a,n)},args:i[a],field:p,window:i.window};m(!!r.sortBy||!(Un.has(a)||!c.window),`${Un.has(a)?`'${a}'`:"bounded window operation"} requires a sortBy.`),m(!c.window||!ip.has(a),`${a} does not accept a 'window' field.`),s.push(c)}return e.forEach((p=>{let i=p.items,a=N(i),c={};for(let f of s){let{func:A,args:O,field:b,window:x}=f,g=T=>{let $=-1;return D=>{if(++$,A.left)return A.left(T(D,$),O,n);if(A.right)return A.right(D,T(D,$),{parentExpr:r,inputExpr:O,documentNumber:$+1,field:b},n)}};if(x){let{documents:T,range:$,unit:D}=x,W=T||$;if(!pp(x)){let[z,ut]=W,_=K=>z=="current"?K:z=="unbounded"?0:Math.max(z+K,0),V=K=>ut=="current"?K+1:ut=="unbounded"?i.length:ut+K+1,ct=(K,At)=>{if(T||W.every(h))return i.slice(_(At),V(At));let $t=Object.keys(r.sortBy)[0],Ht,Jr;if(D){let gt=lr=>Nt(K,{startDate:new Date(K[$t]),unit:D,amount:lr},n).getTime();Ht=d(z)?gt(z):-1/0,Jr=d(ut)?gt(ut):1/0}else{let gt=K[$t];Ht=d(z)?gt+z:-1/0,Jr=d(ut)?gt+ut:1/0}let He=z=="current"?At:0,to=ut=="current"?At+1:i.length,Ge=new Array;for(;He<to;){let gt=i[He++],lr=+gt[$t];lr>=Ht&&lr<=Jr&&Ge.push(gt)}return Ge};c[b]=g(ct)}}c[b]||(c[b]=g(T=>i)),a=kt(a,{[b]:{$function:{body:T=>c[b](T),args:["$$CURRENT"]}}},n)}o.push(a)})),dt(...o)}))};var ap={locf:"$locf",linear:"$linearFill"},mp=(t,r,n)=>{m(!r.sortBy||j(r.sortBy),"sortBy must be an object."),m(!!r.sortBy||Object.values(r.output).every(p=>M(p,"value")),"sortBy required if any output field specifies a 'method'."),m(!(r.partitionBy&&r.partitionByFields),"specify either partitionBy or partitionByFields."),m(!r.partitionByFields||r?.partitionByFields?.every(p=>p[0]!=="$"),"fields in partitionByFields cannot begin with '$'."),n=yt(n),n.context.addExpressionOps({$ifNull:le}),n.context.addWindowOps({$locf:Fe,$linearFill:Ue});let e=r.partitionBy||r?.partitionByFields?.map(p=>"$"+p),o={},s={};for(let[p,i]of Object.entries(r.output))if(M(i,"value"))o[p]={$ifNull:[`$$CURRENT.${p}`,i.value]};else{let a=ap[i.method];m(!!a,`invalid fill method '${i.method}'.`),s[p]={[a]:"$"+p}}return Object.keys(s).length>0&&(t=Ve(t,{sortBy:r.sortBy||{},partitionBy:e,output:s},n)),Object.keys(o).length>0&&(t=kt(t,o,n)),t};function Kr(t,r){let n=!!t&&t[0]?.$documents;return n?{documents:Re(null,n,r).value(),pipeline:t.slice(1)}:{pipeline:t}}var We=(t,r,n)=>{let e=h(r.from)?n?.collectionResolver(r.from):r.from,{let:o,foreignField:s,localField:p}=r,i=O=>[!0,[]],{documents:a,pipeline:c}=Kr(r.pipeline??[],n);if(m(!e!=!a,"$lookup: must specify single join input with `expr.from` or `expr.pipeline`."),e=e??a,m(y(e),"$lookup: join collection must resolve to an array."),s&&p){let O=q.init(n.hashFunction);for(let b of e)et(k(b,s)??null).forEach(x=>{let g=O.get(x),T=g??[];T.push(b),T!==g&&O.set(x,T)});if(i=b=>{let x=k(b,p)??null;if(y(x)){if(c.length)return[x.some($=>O.has($)),null];let T=Array.from(new Set(nt(x.map($=>O.get($),n.hashFunction))));return[T.length>0,T]}let g=O.get(x)??null;return[g!==null,g??[]]},c.length===0)return t.map(b=>({...b,[r.as]:i(b).pop()}))}let f=new pt(c,n),A={...n};return t.map(O=>{let b=u(O,o,null,n);A.variables={...n.variables,...b};let[x,g]=i(O);return{...O,[r.as]:x?f.run(e,A):g}})};var up=(t,r,n)=>{let e=h(r.from)?n?.collectionResolver(r.from):r.from,{connectFromField:o,connectToField:s,as:p,maxDepth:i,depthField:a,restrictSearchWithMatch:c}=r,f=c?{pipeline:[{$match:c}]}:{};return t.map(A=>{let O={};ht(O,o,u(A,r.startWith,null,n));let b=[O],x=-1,g=q.init(n.hashFunction);do{x++,b=nt(We(N(b),{from:e,localField:o,foreignField:s,as:p,...f},n).map(W=>W[p]).value());let D=g.size;if(b.forEach(W=>g.set(W,g.get(W)??x)),D==g.size)break}while(l(i)||x<i);let T=new Array(g.size),$=0;return g.forEach((D,W)=>{T[$++]=Object.assign(a?{[a]:D}:{},W)}),{...A,[p]:T}})};var cr={};lt(cr,{$elemMatch:()=>cp,$slice:()=>lp});var cp=(t,r,n,e)=>{let o=k(t,n),s=new X(r,e);m(y(o),"$elemMatch: argument must resolve to array");let p=[];for(let i=0;i<o.length;i++)if(s.test(o[i])){if(e.useStrictMode)return[o[i]];p.push(o[i])}return p.length>0?p:void 0};var lp=(t,r,n,e)=>{let o=k(t,n),s=r;return y(o)?ce(t,y(r)?[o,...s]:[o,r],e):o};var St={};lt(St,{$all:()=>fp,$and:()=>Ep,$bitsAllClear:()=>Fn,$bitsAllSet:()=>Vn,$bitsAnyClear:()=>Wn,$bitsAnySet:()=>Bn,$elemMatch:()=>yp,$eq:()=>Ln,$exists:()=>Ap,$expr:()=>dp,$gt:()=>zn,$gte:()=>Qn,$in:()=>qn,$jsonSchema:()=>xp,$lt:()=>Kn,$lte:()=>Yn,$mod:()=>gp,$ne:()=>Hn,$nin:()=>Gn,$nor:()=>$p,$not:()=>Ip,$or:()=>Be,$regex:()=>hp,$size:()=>Op,$type:()=>bp,$where:()=>jp});var fp=(t,r,n)=>C(t,r,n,fn);var yp=(t,r,n)=>C(t,r,n,ue);var Op=(t,r,n)=>C(t,r,n,yn);var Et=(t,r,n)=>C(t,r,null,(e,o)=>{let s=0;if(y(o))for(let p of o)s=s|1<<p;else s=o;return n(e&s,s)});var Fn=(t,r,n)=>Et(t,r,(e,o)=>e==0);var Vn=(t,r,n)=>Et(t,r,(e,o)=>e==o);var Wn=(t,r,n)=>Et(t,r,(e,o)=>e<o);var Bn=(t,r,n)=>Et(t,r,(e,o)=>e>0);var Ln=(t,r,n)=>C(t,r,n,er);var zn=(t,r,n)=>C(t,r,n,Sr);var Qn=(t,r,n)=>C(t,r,n,Cr);var qn=(t,r,n)=>C(t,r,n,me);var Kn=(t,r,n)=>C(t,r,n,Nr);var Yn=(t,r,n)=>C(t,r,n,kr);var Hn=(t,r,n)=>C(t,r,n,Tr);var Gn=(t,r,n)=>C(t,r,n,wr);var Ap=(t,r,n)=>{let e=t.includes("."),o=!!r;return!e||t.match(/\.\d+$/)?s=>k(s,t)!==void 0===o:s=>{let p=bt(s,t,{preserveIndex:!0}),i=k(p,t.substring(0,t.lastIndexOf(".")));return y(i)?i.some(a=>a!==void 0)===o:i!==void 0===o}};var bp=(t,r,n)=>C(t,r,n,On);function dp(t,r,n){return e=>L(u(e,r,null,n),n.useStrictMode)}function xp(t,r,n){m(!!n?.jsonSchemaValidator,"$jsonSchema: must configure 'jsonSchemaValidator' option to this operator.");let e=n?.jsonSchemaValidator(r);return o=>e(o)}var gp=(t,r,n)=>C(t,r,n,cn);var hp=(t,r,n)=>C(t,r,n,ln);function jp(t,r,n){m(n.scriptEnabled,"$where: 'scriptEnabled' option must be true");let e=r;return m(Xt(e),"$where only accepts a Function object"),o=>L(e.call(o),n?.useStrictMode)}var Ep=(t,r,n)=>{m(y(r),"Invalid expression: $and expects value to be an Array.");let e=r.map(o=>new X(o,n));return o=>e.every(s=>s.test(o))};var Be=(t,r,n)=>{m(y(r),"Invalid expression. $or expects value to be an Array");let e=r.map(o=>new X(o,n));return o=>e.some(s=>s.test(o))};var $p=(t,r,n)=>{m(y(r),"Invalid expression. $nor expects value to be an array.");let e=Be("$or",r,n);return o=>!e(o)};var Ip=(t,r,n)=>{let e={};e[t]=Or(r);let o=new X(e,n);return s=>!o.test(s)};var Ot=class extends X{constructor(r,n){let e=yt(n);e.context.addExpressionOps(nr).addExpressionOps(or).addProjectionOps(cr).addQueryOps(St),super(r,e)}};var Tp=(t,r,n)=>{let e=new Ot(r,n);return t.filter(o=>e.test(o))};var wp=(t,r,n)=>{let e=h(r.into)?n?.collectionResolver(r.into):r.into;m(y(e),"$merge: option 'into' must resolve to an array");let o=r.on||n.idKey,s=h(o)?a=>Zt(k(a,o),n.hashFunction):a=>Zt(o.map(c=>k(a,c),n.hashFunction)),p=q.init();for(let a=0;a<e.length;a++){let c=e[a],f=s(c);m(!p.has(f),"$merge: 'into' collection must have unique entries for the 'on' field."),p.set(f,[c,a])}let i=I.init(n);return t.map(a=>{let c=s(a);if(p.has(c)){let[f,A]=p.get(c),O=u(f,r.let||{new:"$$ROOT"},null,i.update(a));if(y(r.whenMatched)){let b=new pt(r.whenMatched,{...n,variables:O});e[A]=b.run([f])[0]}else switch(r.whenMatched){case"replace":e[A]=a;break;case"fail":throw new Dt("$merge: failed due to matching as specified by 'whenMatched' option.");case"keepExisting":break;case"merge":default:e[A]=Ne(f,[f,a],i.update(a,{variables:O}));break}}else switch(r.whenNotMatched){case"discard":break;case"fail":throw new Dt("$merge: failed due to matching as specified by 'whenMatched' option.");case"insert":default:e.push(a);break}return a})};var Np=(t,r,n)=>{let e=h(r)?n?.collectionResolver(r):r;return m(y(e),"expression must resolve to an array"),t.map(o=>(e.push(G(o)),o))};var kp=(t,r,n)=>{let e=I.init(n);return t.map(o=>br(o,r,e.update(o)))};var Sp=(t,r,n)=>t.map(e=>(e=u(e,r.newRoot,null,n),m(j(e),"$replaceRoot expression must return an object"),e));var Cp=(t,r,n)=>t.map(e=>(e=u(e,r,null,n),m(j(e),"$replaceWith expression must return an object"),e));var vp=(t,r,n)=>t.transform(e=>{let o=e.length,s=-1;return()=>{if(++s===r.size)return{done:!0};let p=Math.floor(Math.random()*o);return{value:e[p],done:!1}}});var Dp=kt;var _p=(t,r,n)=>Z(ur(t,{_id:r,count:{$sum:1}},n),{count:-1},n);var Mp=(t,r,n)=>{let{coll:e,pipeline:o}=h(r)||y(r)?{coll:r}:r,s=h(e)?n.collectionResolver(e):e,{documents:p,pipeline:i}=Kr(o??[],n);m(!s!=!p,"$unionWith: must specify single collection input with `expr.coll` or `expr.pipeline`.");let a=s??p;return dt(t,i?new pt(i,n).stream(a):N(a))};var Pp=(t,r,n)=>{r=et(r);let e={};for(let o of r)e[o]=0;return rr(t,e,n)};var Rp=(t,r,n)=>{h(r)&&(r={path:r});let o=r.path.substring(1),s=r?.includeArrayIndex||!1,p=r.preserveNullAndEmptyArrays||!1,i=(c,f)=>(s!==!1&&(c[s]=f),c),a;return N(()=>{for(;;){if(a instanceof Ft){let A=a.next();if(!A.done)return A}let c=t.next();if(c.done)return c;let f=c.value;if(a=k(f,o),y(a)){if(a.length===0&&p===!0)return a=null,It(f,o),{value:i(f,null),done:!1};a=N(a).map(((A,O)=>{let b=bt(f,o,{preserveKeys:!0});return ht(b,o,A),i(b,O)}))}else if(!Y(a)||p===!0)return{value:i(f,null),done:!1}}})};var ze={};lt(ze,{$denseRank:()=>Up,$derivative:()=>Fp,$documentNumber:()=>Vp,$expMovingAvg:()=>Wp,$integral:()=>Bp,$linearFill:()=>Ue,$locf:()=>Fe,$minMaxScaler:()=>Lp,$rank:()=>zp,$shift:()=>Qp});var Up=(t,r,n,e)=>Qr(t,r,n,e,!0);var Fp=(t,r,n,e)=>{if(r.length<2)return null;let{input:o,unit:s}=n.inputExpr,p="$"+Object.keys(n.parentExpr.sortBy)[0],i=[r[0],r[r.length-1]],a=E(i,[p,o],e).filter((([x,g])=>d(+x)&&d(+g)));if(a.length!==2)return null;let[[c,f],[A,O]]=a,b=(A-c)/(mt[s]||1);return(O-f)/b};var Vp=(t,r,n,e)=>n.documentNumber;var Wp=(t,r,n,e)=>{let{input:o,N:s,alpha:p}=n.inputExpr;return m(!(s&&p),"You must specify either N or alpha. You cannot specify both."),xt(r,n,()=>{let i=E(r,o,e).filter(d);return i.length===r.length?i:null},i=>{if(i===null)return null;if(n.documentNumber==1)return i[0];let a=s!=null?2/(s+1):p,c=n.documentNumber-1;return i[c]=i[c]*a+i[c-1]*(1-a),i[c]})};var Bp=(t,r,n,e)=>{let{input:o,unit:s}=n.inputExpr,p="$"+Object.keys(n.parentExpr.sortBy)[0],i=E(r,[p,o],e).filter((([f,A])=>d(+f)&&d(+A)));if(i.length!==r.length)return null;let a=0,c=r.length;for(let f=1;f<c;f++){let[A,O]=i[f-1],[b,x]=i[f],g=(b-A)/(mt[s]||1);a+=.5*(O+x)*g}return a};var Lp=(t,r,n,e)=>xt(r,n,()=>{let o=n.inputExpr,s=o.min||0,p=o.max||1,i=E(r,o.input||n.inputExpr,e);m(y(i)&&i.length>0&&i.every(d),"$minMaxScaler: input must be a numeric array");let a=i[0],c=i[0];for(let O of i)O<a?a=O:O>c&&(c=O);let f=p-s,A=c-a;return m(A!==0,"$minMaxScaler: input range must not be zero"),{min:s,scale:f,rmin:a,range:A,nums:i}},o=>{let{min:s,rmin:p,scale:i,range:a,nums:c}=o;return(c[n.documentNumber-1]-p)/a*i+s});var zp=(t,r,n,e)=>Qr(t,r,n,e,!1);var Qp=(t,r,n,e)=>{let o=n.inputExpr,s=n.documentNumber-1+o.by;return s<0||s>r.length-1?o.default?u(t,o.default,null,e):null:u(r[s],o.output,null,e)};var Jn=()=>tt.init().addAccumulatorOps(ie).addExpressionOps(Pe).addPipelineOps(Le).addProjectionOps(cr).addQueryOps(St).addWindowOps(ze);var Yr={};lt(Yr,{$addToSet:()=>Kp,$bit:()=>Hp,$currentDate:()=>Gp,$inc:()=>Jp,$max:()=>Xp,$min:()=>Zp,$mul:()=>ta,$pop:()=>ra,$pull:()=>Qe,$pullAll:()=>ea,$push:()=>oa,$rename:()=>sa,$set:()=>qe,$unset:()=>ia});var v={cloneMode:"copy",queryOptions:yt({context:tt.init().addQueryOps(St).addExpressionOps(nr).addExpressionOps(or)})},Yt=(t,r)=>{switch(t){case"deep":return G(r);case"copy":return S(r)?new Date(r):y(r)?[...r]:j(r)?{...r}:H(r)?new RegExp(r):r;default:return r}},qp=/^[a-z]+[a-zA-Z0-9]*$/;function Xn(t){if(!t.includes(".$"))return[{parent:t,selector:t},[]];let r=t.indexOf(".$"),n=t.indexOf("]"),e=t.substring(0,r),o=t.substring(r+3,n);m(o===""||qp.test(o),"The filter <identifier> must begin with a lowercase letter and contain only alphanumeric characters.");let s=t.substring(n+2),[p,i]=s?Xn(s):[];return[{selector:t,parent:e,child:o||"$",next:p},[o,...i||[]].filter(Boolean)]}var U=(t,r,n,e,o)=>{let{parent:s,child:p,next:i}=r;if(!p){let c=!1;return _t(t,s,(A,O)=>c=!!e(A,O)||c,o),c}let a=k(t,s);return y(a)?a.map((c,f)=>n[p]&&!n[p].test({[p]:c})?!1:i?U(c,i,n,e,o):e(a,f)).some(Boolean):!1};function F(t,r,n,e){let o=[];for(let[s,p]of Object.entries(t)){let[i,a]=Xn(s);if(!a.length)e(p,i,{})&&o.push(i.parent);else{let c={};r.forEach(A=>{Object.keys(A).forEach(O=>{a.forEach(b=>{(O===b||O.startsWith(b+"."))&&(c[b]=c[b]||{},Object.assign(c[b],{[O]:A[O]}))})})});let f={};for(let[A,O]of Object.entries(c))f[A]=new Ot(O,n.queryOptions);e(p,i,f)&&o.push(i.parent)}}return o}var Kp=(t,r,n=[],e=v)=>F(r,n,e,(o,s,p)=>{let i={$each:[o]};return j(o)&&M(o,"$each")&&Object.assign(i,o),U(t,s,p,(a,c)=>{let f=a[c]||=[];return Mt([f,i.$each]).length===i.$each.length?!1:(a[c]=Yt(e.cloneMode,Pt(f.concat(i.$each))),!0)},{buildGraph:!0})});var Yp=new Set(["and","or","xor"]),Hp=(t,r,n=[],e=v)=>F(r,n,e,((o,s,p)=>{let i=Object.keys(o);return m(i.length===1&&Yp.has(i[0]),`Invalid bit operator '${i[0]}'. Must be one of 'and', 'or', or 'xor'.`),U(t,s,p,(a,c)=>{let f=a[c],A=o[i[0]];if(f!==void 0&&!(d(f)&&d(A)))return!1;switch(f=f||0,i[0]){case"and":a[c]=f&A;break;case"or":a[c]=f|A;break;case"xor":a[c]=f^A;break}return a[c]!==f},{buildGraph:!0})}));var Gp=(t,r,n=[],e=v)=>{let o=Date.now();return F(r,n,e,((s,p,i)=>U(t,p,i,(a,c)=>(a[c]=o,!0),{buildGraph:!0})))};var Jp=(t,r,n=[],e=v)=>F(r,n,e,(o,s,p)=>{if(!s.child){let i=k(t,s.parent);m(i===void 0||d(i),"cannot apply $inc to a value of non-numeric type")}return U(t,s,p,(i,a)=>(i[a]=(i[a]||=0)+o,!0),{buildGraph:!0})});var Xp=(t,r,n=[],e=v)=>F(r,n,e,((o,s,p)=>U(t,s,p,(i,a)=>i[a]!==void 0&&w(i[a],o)>-1?!1:(i[a]=o,!0),{buildGraph:!0})));var Zp=(t,r,n=[],e=v)=>F(r,n,e,((o,s,p)=>U(t,s,p,(i,a)=>i[a]!==void 0&&w(i[a],o)<1?!1:(i[a]=o,!0),{buildGraph:!0})));var ta=(t,r,n=[],e=v)=>F(r,n,e,((o,s,p)=>U(t,s,p,(i,a)=>{let c=i[a];return i[a]=i[a]===void 0?0:i[a]*o,i[a]!==c},{buildGraph:!0})));var ra=(t,r,n=[],e=v)=>F(r,n,e,((o,s,p)=>U(t,s,p,(i,a)=>{let c=i[a];return m(y(c),`path '${s.selector}' contains an element of non-array type.`),c.length?(o===-1?c.splice(0,1):c.pop(),!0):!1})));var Qe=(t,r,n=[],e=v)=>F(r,n,e,((o,s,p)=>{let i=!j(o)||Object.keys(o).some(J),a=new Ot(i?{k:o}:o,e.queryOptions),c=i?f=>a.test({k:f}):f=>a.test(f);return U(t,s,p,(f,A)=>{let O=f[A],b=new Array;return O.map(g=>{let T=c(g);return T||b.push(g),T}).some(Boolean)?(f[A]=b,!0):!1})}));var ea=(t,r,n=[],e=v)=>{let o={};return Object.entries(r).forEach(([s,p])=>{o[s]={$in:p}}),Qe(t,o,n,e)};var na=["$each","$slice","$sort","$position"],oa=(t,r,n=[],e=v)=>F(r,n,e,((o,s,p)=>{let i={$each:[o]};return j(o)&&na.some(a=>M(o,a))&&Object.assign(i,o),U(t,s,p,(a,c)=>{let f=a[c]||=[],A=f.slice(0,i.$slice||f.length),O=f.length,b=d(i.$position)?i.$position:f.length;if(f.splice(b,0,...Yt(e.cloneMode,i.$each)),i.$sort){let x=j(i.$sort)?Object.keys(i.$sort||{}).pop():"",g=x?i.$sort[x]:i.$sort,T=x?$=>k($,x):$=>$;f.sort(($,D)=>g*w(T($),T(D)))}return d(i.$slice)&&(i.$slice<0?f.splice(0,f.length+i.$slice):f.splice(i.$slice)),O!=f.length||!B(A,f)},{descendArray:!0,buildGraph:!0})}));var qe=(t,r,n=[],e=v)=>F(r,n,e,(o,s,p)=>U(t,s,p,(i,a)=>B(i[a],o)?!1:(i[a]=Yt(e.cloneMode,o),!0),{buildGraph:!0}));var sa=(t,r,n=[],e=v)=>{let o=[],s=F(r,n,e,((p,i,a)=>U(t,i,a,(c,f)=>M(c,f)?(o.push(...qe(t,{[p]:c[f]},n,e)),delete c[f],!0):!1)));return Array.from(new Set(s.concat(o)))};var ia=(t,r,n=[],e=v)=>F(r,n,e,(o,s,p)=>U(t,s,p,(i,a)=>M(i,a)?(y(i)?i[a]=null:delete i[a],!0):!1));function Ke(t){return t=t??v,(r,n,e=[],o={},s=t)=>{let p=Object.entries(n);m(p.length===1,"Update expression must contain only one operator.");let[i,a]=p[0];m(M(Yr,i),`Update operator '${i}' is not supported.`);let c=Yr[i];return Object.keys(o).length&&!new Ot(o,s.queryOptions).test(r)?[]:c(r,a,e,s)}}var pS=Ke();var pa=Jn(),Ye=t=>{let r=yt(t);return{...r,context:tt.merge(pa,r.context)}},Hr=class extends X{constructor(r,n){super(r,Ye(n))}},Gr=class extends pt{constructor(r,n){super(r,Ye(n))}},Zn=t=>Ke({...t,queryOptions:Ye(t?.queryOptions)}),aa=Zn(),ma=(t,r,n)=>new Gr(r,n).run(t),ua=(t,r,n,e)=>new Hr(r,e).find(t,n);return so(ca);})();
